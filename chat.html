<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bubli - Chat. Play. Connect.</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            bubli: {
              primary: '#7B5BE4',
              light: '#C9B7FF',
              dark: '#5A3DC7',
              cream: '#FAF8FF',
              accent: '#E8DFFF',
              glow: '#9D8AFF'
            }
          },
          fontFamily: {
            display: ['Nunito', 'sans-serif'],
            body: ['DM Sans', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style>
    :root {
      --bg: #FAF8FF;
      --fg: #2D2847;
      --muted: #6B6488;
      --accent: #7B5BE4;
      --accent-light: #C9B7FF;
      --card: #FFFFFF;
      --border: #E8E4F0;
      --sidebar: #F5F0FF;
      --bubble-own: #7B5BE4;
      --bubble-other: #FFFFFF;
    }

    .dark {
      --bg: #1A1625;
      --fg: #F5F0FF;
      --muted: #9D8AFF;
      --accent: #9D8AFF;
      --accent-light: #5A3DC7;
      --card: #2D2640;
      --border: #3D3555;
      --sidebar: #231E33;
      --bubble-own: #7B5BE4;
      --bubble-other: #2D2640;
    }

    * { box-sizing: border-box; }
    
    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--fg);
      overflow: hidden;
    }

    .font-display { font-family: 'Nunito', sans-serif; }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--accent-light); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

    @keyframes float { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-15px) rotate(3deg); } }
    @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(1.3); opacity: 1; } }
    @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }
    @keyframes messageIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 50% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; } }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

    .animate-float { animation: float 8s ease-in-out infinite; }
    .animate-pulse-soft { animation: pulse 2s ease-in-out infinite; }
    .typing-dot { animation: typing 1.4s ease-in-out infinite; }
    .typing-dot:nth-child(2) { animation-delay: 0.15s; }
    .typing-dot:nth-child(3) { animation-delay: 0.3s; }
    .animate-message-in { animation: messageIn 0.3s ease-out; }
    .animate-pop-in { animation: popIn 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    
    /* Skeleton Loading */
    .skeleton {
        background: linear-gradient(90deg, var(--border) 25%, var(--accent-light) 50%, var(--border) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }

    .message-bubble { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .message-bubble:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(123, 91, 228, 0.15); }
    .message-own { background: linear-gradient(135deg, #7B5BE4 0%, #9D8AFF 100%); border-radius: 20px 20px 6px 20px; }
    .message-other { background: var(--bubble-other); border-radius: 20px 20px 20px 6px; box-shadow: 0 2px 8px rgba(123, 91, 228, 0.08); }
    .dark .message-other { box-shadow: none; border: 1px solid var(--border); }

    .sidebar-item { transition: all 0.2s ease; border-left: 3px solid transparent; }
    .sidebar-item:hover { background: rgba(123, 91, 228, 0.08); border-left-color: rgba(123, 91, 228, 0.3); }
    .sidebar-item.active { background: linear-gradient(90deg, rgba(123, 91, 228, 0.15) 0%, transparent 100%); border-left-color: var(--accent); }

    .btn-send { background: linear-gradient(135deg, #7B5BE4 0%, #9D8AFF 100%); transition: all 0.2s ease; }
    .btn-send:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(123, 91, 228, 0.35); }
    .btn-send:active { transform: scale(0.95); }

    .btn-profile { transition: all 0.2s ease; }
    .btn-profile:hover { background: rgba(123, 91, 228, 0.1); transform: scale(1.02); }

    .chat-input { background: var(--card); border: 2px solid var(--border); transition: all 0.2s ease; }
    .chat-input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(123, 91, 228, 0.1); }

    /* Only animate the dot if it has the class */
    .online-dot.is-online { animation: pulse 2s ease-in-out infinite; }

    .emoji-picker { background: var(--card); border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(123, 91, 228, 0.2); }
    .emoji-btn { transition: transform 0.15s ease; }
    .emoji-btn:hover { transform: scale(1.3); }

    .theme-toggle { transition: transform 0.3s ease; }
    .theme-toggle:hover { transform: rotate(180deg); }

    .gradient-text { background: linear-gradient(135deg, #7B5BE4 0%, #5A3DC7 50%, #9D8AFF 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

    .modal-overlay { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); }
    .modal-content { background: var(--card); box-shadow: 0 25px 50px rgba(123, 91, 228, 0.25); }

    @media (max-width: 768px) {
      .sidebar-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 40; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
      .sidebar-overlay.active { opacity: 1; pointer-events: auto; }
      .sidebar-mobile { transform: translateX(-100%); transition: transform 0.3s ease; }
      .sidebar-mobile.active { transform: translateX(0); }
    }

    .floating-bubble { position: absolute; border-radius: 50%; pointer-events: none; opacity: 0.08; }
  </style>
</head>
<body class="h-screen flex flex-col dark:bg-[#1A1625]">
  <!-- Floating Background -->
  <div class="fixed inset-0 pointer-events-none overflow-hidden z-0">
    <div class="floating-bubble w-40 h-40 bg-bubli-primary top-20 left-20 animate-float" style="animation-duration: 12s;"></div>
    <div class="floating-bubble w-28 h-28 bg-bubli-light top-1/3 right-24 animate-float" style="animation-duration: 16s; animation-delay: 2s;"></div>
    <div class="floating-bubble w-20 h-20 bg-bubli-glow bottom-32 left-1/4 animate-float" style="animation-duration: 14s; animation-delay: 4s;"></div>
  </div>

  <div class="flex-1 flex relative z-10 overflow-hidden">
    <div class="sidebar-overlay md:hidden" id="sidebar-overlay" onclick="toggleMobileSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar-mobile md:transform-none fixed md:relative z-50 md:z-auto w-80 h-full flex flex-col border-r border-bubli-accent/20 dark:border-[#3D3555]" style="background: var(--sidebar);" id="sidebar">
      <!-- Sidebar Header -->
      <div class="p-4 border-b border-bubli-accent/20 dark:border-[#3D3555]">
        <div class="flex items-center justify-between mb-4">
          <a href="#" class="flex items-center gap-2 group">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-bubli-primary to-bubli-glow flex items-center justify-center shadow-lg group-hover:scale-105 transition-transform">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="8" fill="white"/><circle cx="9" cy="10" r="1.5" fill="#7B5BE4"/><circle cx="15" cy="10" r="1.5" fill="#7B5BE4"/><path d="M9 14c1 1.5 5 1.5 6 0" stroke="#7B5BE4" stroke-width="1.5" stroke-linecap="round"/></svg>
            </div>
            <span class="font-display font-800 text-xl gradient-text dark:text-white">Bubli</span>
          </a>
          <button onclick="toggleTheme()" class="theme-toggle p-2 rounded-lg hover:bg-bubli-accent/20 transition-colors" aria-label="Toggle theme">
            <svg class="w-5 h-5 text-bubli-primary dark:text-bubli-light dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
            <svg class="w-5 h-5 text-bubli-light hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
          </button>
        </div>

        <!-- Search -->
        <div class="relative mb-2">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-bubli-dark/40 dark:text-white/40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          <input type="text" placeholder="Search chats..." class="w-full pl-10 pr-4 py-2.5 rounded-xl bg-bubli-accent/20 dark:bg-[#2D2640] border-0 outline-none text-sm text-bubli-dark dark:text-white placeholder-bubli-dark/40 focus:ring-2 focus:ring-bubli-primary/50">
        </div>

        <!-- Add Friend -->
        <div class="flex items-center gap-2 mb-2">
          <input type="text" id="friend-username" placeholder="Add friend by username..." class="flex-1 px-3 py-2 text-sm rounded-xl bg-bubli-accent/20 dark:bg-[#2D2640] border-0 outline-none focus:ring-2 focus:ring-bubli-primary/50">
          <button onclick="sendFriendRequest()" class="px-3 py-2 rounded-xl bg-bubli-primary text-white text-sm font-semibold hover:bg-bubli-dark transition shadow-sm">Add</button>
        </div>

        <!-- Friend Requests -->
        <div class="border-t border-bubli-accent/20 dark:border-[#3D3555] pt-2 mt-2">
          <h3 class="text-xs font-display font-700 text-bubli-dark/50 dark:text-white/50 uppercase tracking-wider mb-2">Requests</h3>
          <div id="requests-list" class="space-y-2 max-h-32 overflow-y-auto">
             <!-- Requests render here -->
          </div>
        </div>
      </div>

      <!-- Chat List -->
      <div class="flex-1 overflow-y-auto p-2">
        <div class="mb-4">
          <h3 class="px-3 py-2 text-xs font-display font-700 text-bubli-dark/50 dark:text-white/50 uppercase tracking-wider">Private Chats</h3>
          <div id="private-chats-list">
             <!-- Loading state handled by JS -->
          </div>
        </div>
        <div>
          <h3 class="px-3 py-2 text-xs font-display font-700 text-bubli-dark/50 dark:text-white/50 uppercase tracking-wider">Group Chats</h3>
          <div id="group-chats-list"></div>
        </div>
      </div>

      <!-- User Profile Trigger -->
      <div class="p-4 border-t border-bubli-accent/20 dark:border-[#3D3550]" style="background: var(--card);">
        <button id="sidebar-profile-btn" class="w-full flex items-center gap-3 p-2 rounded-xl hover:bg-bubli-accent/10 transition-colors">
          <div class="relative">
            <img id="current-user-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=You&backgroundColor=c0aede" alt="Your avatar" class="w-10 h-10 rounded-full">
            <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white dark:border-[#2D2640] online-dot is-online"></span>
          </div>
          <div class="flex-1 text-left">
            <p id="current-user-name" class="font-display font-700 text-sm text-bubli-dark dark:text-white">Loading...</p>
            <p class="text-xs text-green-500">Online</p>
          </div>
          <svg class="w-4 h-4 text-bubli-dark/30 dark:text-white/30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
        </button>
      </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="flex-1 flex flex-col min-w-0" style="background: var(--bg);">
      <!-- Chat Header -->
      <header class="flex-shrink-0 flex items-center gap-3 p-4 border-b border-bubli-accent/20 dark:border-[#3D3550]" style="background: var(--card);">
        <button class="md:hidden p-2 rounded-lg hover:bg-bubli-accent/20 transition-colors" onclick="toggleMobileSidebar()" aria-label="Open menu">
          <svg class="w-5 h-5 text-bubli-dark dark:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
        
        <div id="chat-header-content" class="flex-1">
             <!-- Header content rendered by JS -->
        </div>

        <!-- Action buttons rendered by JS logic but static placeholder for layout stability -->
        <button id="header-action-btn" class="btn-profile ml-auto px-4 py-2 rounded-xl font-display font-600 text-sm text-bubli-primary dark:text-bubli-light flex items-center gap-2 opacity-0 pointer-events-none transition-opacity">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
          <span class="hidden sm:inline">View Profile</span>
        </button>
      </header>

      <!-- Messages Area -->
      <div class="flex-1 overflow-y-auto p-4 space-y-3" id="messages-container">
          <!-- Default Welcome State -->
          <div class="h-full flex flex-col items-center justify-center text-center px-4 animate-fade-up">
             <div class="w-20 h-20 rounded-full bg-bubli-accent/20 flex items-center justify-center mb-4">
                <svg class="w-10 h-10 text-bubli-primary/60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
             </div>
             <h3 class="font-display font-800 text-lg text-bubli-dark dark:text-white mb-1">Welcome to Bubli!</h3>
             <p class="text-sm text-bubli-dark/50 dark:text-white/50 max-w-xs">Select a chat or add a friend to start.</p>
          </div>
      </div>

      <!-- Typing Indicator -->
      <div class="flex-shrink-0 px-4 pb-2 h-6" id="typing-container">
        <div class="hidden items-center gap-2 text-sm text-bubli-dark/50 dark:text-white/50" id="typing-indicator">
          <div class="flex gap-1">
            <div class="w-1.5 h-1.5 rounded-full bg-bubli-primary typing-dot"></div>
            <div class="w-1.5 h-1.5 rounded-full bg-bubli-primary typing-dot"></div>
            <div class="w-1.5 h-1.5 rounded-full bg-bubli-primary typing-dot"></div>
          </div>
          <span id="typing-text">Someone is typing...</span>
        </div>
      </div>

      <!-- Message Input -->
      <div class="flex-shrink-0 p-4 border-t border-bubli-accent/20 dark:border-[#3D3550]" style="background: var(--card);">
        <div class="flex items-end gap-2">
          <button onclick="toggleEmojiPicker()" class="flex-shrink-0 p-3 rounded-xl hover:bg-bubli-accent/20 transition-colors" aria-label="Add emoji">
            <svg class="w-5 h-5 text-bubli-dark/50 dark:text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          </button>
          <div class="flex-1 relative">
            <textarea id="message-input" placeholder="Say something bubbly..." rows="1" class="chat-input w-full px-4 py-3 rounded-2xl outline-none resize-none text-bubli-dark dark:text-white placeholder-bubli-dark/40 text-sm" onkeydown="handleKeyDown(event)" oninput="autoResize(this)"></textarea>
          </div>
          <button onclick="sendMessage()" class="btn-send flex-shrink-0 p-3 rounded-xl" aria-label="Send message">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
          </button>
        </div>
      </div>

      <!-- Emoji Picker -->
      <div class="emoji-picker absolute bottom-20 left-4 w-72 rounded-2xl p-3 hidden z-50 animate-pop-in" id="emoji-picker">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-display font-700 text-sm text-bubli-dark dark:text-white">Emojis</h4>
          <button onclick="toggleEmojiPicker()" class="p-1 rounded hover:bg-bubli-accent/20"><svg class="w-4 h-4 text-bubli-dark/50 dark:text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
        </div>
        <div class="grid grid-cols-8 gap-0.5" id="emoji-grid"></div>
      </div>
    </main>
  </div>

  <!-- Profile Modal -->
  <div class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center p-4" id="profile-modal">
    <div class="modal-content rounded-3xl p-6 w-full max-w-sm animate-pop-in">
      <div class="text-center">
        <div class="relative inline-block mb-4">
          <img id="profile-avatar" src="" alt="Profile" class="w-24 h-24 rounded-full border-4 border-bubli-accent/30">
          <span id="profile-status" class="absolute bottom-1 right-1 w-5 h-5 bg-green-500 rounded-full border-3 border-white dark:border-[#2D2640]"></span>
        </div>
        <h3 id="profile-name" class="font-display font-800 text-xl text-bubli-dark dark:text-white mb-1"></h3>
        <p id="profile-status-text" class="text-sm text-green-500 mb-4">Online</p>
        <div class="bg-bubli-accent/10 dark:bg-bubli-primary/20 rounded-2xl p-4 mb-4">
          <div class="grid grid-cols-2 gap-4 text-center">
            <div><p id="profile-messages" class="font-display font-800 text-2xl text-bubli-primary dark:text-bubli-light">0</p><p class="text-xs text-bubli-dark/50 dark:text-white/50">Messages</p></div>
            <div><p id="profile-chats" class="font-display font-800 text-2xl text-bubli-primary dark:text-bubli-light">0</p><p class="text-xs text-bubli-dark/50 dark:text-white/50">Shared Chats</p></div>
          </div>
        </div>
        <div class="flex gap-2">
          <button onclick="closeProfile()" class="flex-1 py-3 rounded-xl border-2 border-bubli-accent/30 font-display font-600 text-bubli-dark dark:text-white hover:bg-bubli-accent/10 transition-colors">Close</button>
          <button onclick="startDirectChat()" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-bubli-primary to-bubli-glow font-display font-600 text-white hover:shadow-lg transition-all">Send Message</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Request Modal -->
  <div class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center p-4" id="request-modal">
    <div class="modal-content rounded-3xl p-6 w-full max-w-sm animate-pop-in">
      <div class="text-center">
        <div class="relative inline-block mb-4">
          <img id="request-avatar" src="" alt="User" class="w-20 h-20 rounded-full border-4 border-bubli-accent/30">
        </div>
        <h3 id="request-username" class="font-display font-800 text-xl text-bubli-dark dark:text-white mb-4"></h3>
        <p class="text-sm text-bubli-dark/60 dark:text-white/60 mb-6">wants to chat with you</p>
        <div class="flex gap-3">
          <button id="accept-request-btn" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-green-500 to-emerald-500 font-display font-600 text-white hover:shadow-lg transition-all flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
            Accept
          </button>
          <button id="reject-request-btn" class="flex-1 py-3 rounded-xl border-2 border-red-400 font-display font-600 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            Decline
          </button>
        </div>
        <button onclick="closeRequestModal()" class="mt-4 text-sm text-bubli-dark/40 dark:text-white/40 hover:text-bubli-primary dark:hover:text-bubli-light">Close</button>
      </div>
    </div>
  </div>

<script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = 'https://yhrfzhwjheuavmsiielj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlocmZ6aHdqaGV1YXZtc2lpZWxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MTY1ODksImV4cCI6MjA4NzI5MjU4OX0.0tHWAWqwOTs8Bw4_AtDUEOZGhuM_y0Oukm-t-BzPano';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------- Global state ----------
    let currentUser = null;
    let currentProfile = null;
    let currentChat = null;
    let privateChats = [];
    let groupChats = [];
    let pendingRequests = [];
    let messages = [];
    let activeSubscriptions = [];
    let typingTimeouts = {};

    let currentRequestId = null;
    let currentRequestSenderId = null;

    // DOM elements
    const privateChatsList = document.getElementById('private-chats-list');
    const groupChatsList = document.getElementById('group-chats-list');
    const requestsList = document.getElementById('requests-list');
    const chatHeaderContent = document.getElementById('chat-header-content');
    const headerActionBtn = document.getElementById('header-action-btn');
    const messagesContainer = document.getElementById('messages-container');
    const messageInput = document.getElementById('message-input');
    const emojiPicker = document.getElementById('emoji-picker');
    const emojiGrid = document.getElementById('emoji-grid');
    const typingIndicator = document.getElementById('typing-indicator');
    const typingText = document.getElementById('typing-text');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const profileModal = document.getElementById('profile-modal');
    const friendUsernameInput = document.getElementById('friend-username');

    const emojis = ['üòÄ', 'üòÇ', 'ü•∞', 'üòé', 'ü§î', 'üòç', 'üéâ', 'üëã', '‚ù§Ô∏è', 'üî•', '‚ú®', 'üëè', 'üòä', 'ü§ó', 'üíï', 'üôå', 'üí™', 'ü•≥', 'üòÑ', 'üíñ', 'üåü', '‚ò∫Ô∏è', 'üòã', 'ü§©', 'üò∫', 'ü§≠', 'üòá', 'üôÉ', 'üòå', 'ü•∫'];

    // ---------- Helper ----------
    function showMessage(msg, isError = false) {
        const toast = document.createElement('div');
        const bg = isError ? 'bg-red-500' : 'bg-green-500';
        toast.className = `fixed top-4 right-4 ${bg} text-white px-4 py-2 rounded-xl shadow-lg z-50 animate-fade-up flex items-center gap-2`;
        toast.innerHTML = `<span class="font-semibold">${msg}</span>`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // ---------- Authentication ----------
    async function loadCurrentUser() {
        try {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.href = 'signin.html'; return; }
            currentUser = session.user;

            const { data: profile, error } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
            if (error) throw error;
            currentProfile = profile;

            const avatarEl = document.getElementById('current-user-avatar');
            const nameEl = document.getElementById('current-user-name');
            if (avatarEl) avatarEl.src = profile.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${profile.username}`;
            if (nameEl) nameEl.textContent = profile.username;

            document.getElementById('sidebar-profile-btn').onclick = () => viewProfile(currentUser.id);
            setupPresence();
        } catch (err) {
            console.error('Error loading user:', err);
            showMessage('Failed to load user.', true);
            setTimeout(() => window.location.href = 'signin.html', 1500);
        }
    }

    // ---------- Presence ----------
    async function setupPresence() {
        const channel = supabase.channel('online-users', { config: { presence: { key: currentUser.id } } });
        channel
            .on('presence', { event: 'sync' }, () => updateOnlineStatus(channel.presenceState()))
            .subscribe(async (status) => {
                if (status === 'SUBSCRIBED') await channel.track({ online_at: new Date().toISOString() });
            });
        activeSubscriptions.push(channel);
    }

    function updateOnlineStatus(presenceState) {
        document.querySelectorAll('.chat-item[data-user-id]').forEach(el => {
            const userId = el.dataset.userId;
            const onlineDot = el.querySelector('.online-dot');
            if (onlineDot) {
                const isOnline = !!presenceState[userId];
                // Only animate if online
                onlineDot.className = `online-dot absolute bottom-0 right-0 w-3.5 h-3.5 rounded-full border-2 border-white dark:border-[#231E33] ${isOnline ? 'bg-green-500 is-online' : 'bg-gray-400'}`;
            }
        });
        
        // Update header status if viewing a private chat
        if (currentChat && !currentChat.is_group && currentChat.otherUser) {
            const isOnline = !!presenceState[currentChat.otherUser.id];
            const headerDot = document.getElementById('chat-header-online-dot');
            if (headerDot) {
                headerDot.className = `absolute bottom-0 right-0 w-3.5 h-3.5 rounded-full border-2 border-white dark:border-[#231E33] ${isOnline ? 'bg-green-500 is-online' : 'bg-gray-400'}`;
            }
             const statusText = document.getElementById('chat-header-status');
             if (statusText) {
                 statusText.textContent = isOnline ? 'Online' : 'Offline';
                 statusText.className = `text-xs ${isOnline ? 'text-green-500' : 'text-gray-500'}`;
             }
        }
    }

    // ---------- Load chats ----------
    async function loadChats() {
        if (!currentUser) return;
        const { data: participations } = await supabase.from('chat_participants').select('chat_id').eq('user_id', currentUser.id);
        
        if (!participations || participations.length === 0) {
            privateChats = []; groupChats = []; renderChatLists(); return;
        }

        const chatIds = participations.map(p => p.chat_id);
        const { data: chats } = await supabase.from('chats').select('*').in('id', chatIds);

        privateChats = [];
        groupChats = [];

        for (const chat of chats) {
            const { data: lastMsg } = await supabase.from('messages').select('content, created_at, sender_id').eq('chat_id', chat.id).order('created_at', { ascending: false }).limit(1).maybeSingle();
            chat.lastMessage = lastMsg;

            if (chat.is_group) {
                const { data: members } = await supabase.from('chat_participants').select('user_id, profiles(id, username, avatar_url)').eq('chat_id', chat.id);
                chat.members = members ? members.map(m => m.profiles) : [];
                groupChats.push(chat);
            } else {
                const { data: other } = await supabase.from('chat_participants').select('user_id, profiles(id, username, avatar_url)').eq('chat_id', chat.id).neq('user_id', currentUser.id).single();
                chat.otherUser = other?.profiles;
                privateChats.push(chat);
            }
        }
        renderChatLists();
    }

    // ---------- Subscriptions ----------
    function subscribeToChatChanges() {
        const chatParticipantsChannel = supabase.channel('chat-participants-changes')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_participants', filter: `user_id=eq.${currentUser.id}` }, loadChats)
            .subscribe();
        activeSubscriptions.push(chatParticipantsChannel);

        const messagesChannel = supabase.channel('messages-changes')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, (payload) => {
                const newMsg = payload.new;
                const chat = [...privateChats, ...groupChats].find(c => c.id === newMsg.chat_id);
                if (chat) { chat.lastMessage = newMsg; renderChatLists(); }
            })
            .subscribe();
        activeSubscriptions.push(messagesChannel);
    }

    // ---------- Render ----------
    function renderChatLists() {
        const presenceState = activeSubscriptions.find(s => s.topic?.startsWith('presence:online-users'))?.presenceState() || {};

        if (privateChats.length === 0) {
            privateChatsList.innerHTML = `<div class="text-center text-xs text-bubli-dark/40 dark:text-white/40 py-4 px-4">No chats yet.<br>Add a friend to start!</div>`;
        } else {
            privateChatsList.innerHTML = privateChats.map(chat => {
                const otherUserId = chat.otherUser?.id;
                const isOnline = !!presenceState[otherUserId];
                const lastMsg = chat.lastMessage;
                const lastMsgText = lastMsg ? (lastMsg.sender_id === currentUser.id ? 'You: ' : '') + lastMsg.content : 'No messages yet';
                const lastMsgTime = lastMsg ? new Date(lastMsg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';

                return `
                    <div class="sidebar-item flex items-center gap-3 p-2 rounded-xl cursor-pointer mb-1 chat-item ${currentChat?.id === chat.id ? 'active' : ''}" onclick="selectChat('${chat.id}', false)" data-user-id="${otherUserId || ''}">
                        <div class="relative flex-shrink-0">
                            <img src="${chat.otherUser?.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${chat.otherUser?.username}`}" class="w-12 h-12 rounded-full">
                            <span class="online-dot absolute bottom-0 right-0 w-3.5 h-3.5 rounded-full border-2 border-white dark:border-[#231E33] ${isOnline ? 'bg-green-500 is-online' : 'bg-gray-400'}"></span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <p class="font-display font-600 text-sm truncate">${chat.otherUser?.username}</p>
                                <span class="text-xs text-bubli-dark/40 dark:text-white/40 flex-shrink-0 ml-2">${lastMsgTime}</span>
                            </div>
                            <p class="text-xs text-bubli-dark/50 dark:text-white/50 truncate">${lastMsgText}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        groupChatsList.innerHTML = groupChats.map(chat => {
            const lastMsg = chat.lastMessage;
            const lastMsgText = lastMsg ? (lastMsg.sender_id === currentUser.id ? 'You: ' : '') + lastMsg.content : 'No messages yet';
            const lastMsgTime = lastMsg ? new Date(lastMsg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            return `
                <div class="sidebar-item flex items-center gap-3 p-2 rounded-xl cursor-pointer mb-1 chat-item ${currentChat?.id === chat.id ? 'active' : ''}" onclick="selectChat('${chat.id}', true)">
                    <div class="flex -space-x-2 flex-shrink-0">
                        ${chat.members.slice(0, 3).map(m => `<img src="${m.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${m.username}`}" class="w-10 h-10 rounded-full border-2 border-white dark:border-[#231E33]">`).join('')}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <p class="font-display font-600 text-sm truncate">${chat.name || 'Group Chat'}</p>
                            <span class="text-xs text-bubli-dark/40 dark:text-white/40 flex-shrink-0 ml-2">${lastMsgTime}</span>
                        </div>
                        <p class="text-xs text-bubli-dark/50 dark:text-white/50 truncate">${lastMsgText}</p>
                    </div>
                </div>
            `;
        }).join('');
    }

    // ---------- Friend Requests ----------
    async function loadFriendRequests() {
        if (!currentUser) return;
        const { data: requests } = await supabase.from('friend_requests').select('*, sender:profiles!sender_id(username, avatar_url), receiver:profiles!receiver_id(username, avatar_url)').or(`receiver_id.eq.${currentUser.id},sender_id.eq.${currentUser.id}`).eq('status', 'pending');
        pendingRequests = requests || [];
        renderRequests();
    }

    window.sendFriendRequest = async function() {
        const username = friendUsernameInput?.value.trim();
        if (!username) return;
        const { data: targetUser } = await supabase.from('profiles').select('id').eq('username', username).single();
        if (!targetUser) { showMessage('User not found', true); return; }
        if (targetUser.id === currentUser.id) { showMessage('You cannot add yourself', true); return; }
        
        const { data: existing } = await supabase.from('friend_requests').select('id').or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${targetUser.id}),and(sender_id.eq.${targetUser.id},receiver_id.eq.${currentUser.id})`).maybeSingle();
        if (existing) { showMessage('Request already pending', true); return; }

        const { error } = await supabase.from('friend_requests').insert({ sender_id: currentUser.id, receiver_id: targetUser.id });
        if (error) { showMessage('Error sending request', true); console.error(error); } 
        else { showMessage('Friend request sent!'); friendUsernameInput.value = ''; }
    };

    window._acceptingRequest = false;

    window.acceptRequest = async function(requestId, senderId) {
        if (!currentUser) { showMessage('Session expired', true); return; }
        if (window._acceptingRequest) return;
        window._acceptingRequest = true;

        try {
            // 1. Check for existing chat
            const { data: existingChats } = await supabase.from('chat_participants').select('chat_id').eq('user_id', currentUser.id);
            if (existingChats && existingChats.length > 0) {
                const chatIds = existingChats.map(c => c.chat_id);
                const { data: mutualChats } = await supabase.from('chat_participants').select('chat_id, chats!inner(is_group)').in('chat_id', chatIds).eq('user_id', senderId).eq('chats.is_group', false);
                if (mutualChats && mutualChats.length > 0) {
                    const existingChatId = mutualChats[0].chat_id;
                    await supabase.from('friend_requests').update({ status: 'accepted' }).eq('id', requestId);
                    await loadChats();
                    const chat = privateChats.find(c => c.id === existingChatId);
                    if (chat) selectChat(chat.id, false);
                    loadFriendRequests();
                    window._acceptingRequest = false;
                    return;
                }
            }

            // 2. Create new chat
            await supabase.from('friend_requests').update({ status: 'accepted' }).eq('id', requestId);
            
            const { data: newChat, error: chatError } = await supabase.from('chats').insert({ is_group: false }).select().single();
            if (chatError || !newChat) throw new Error(chatError?.message || 'Chat creation failed');

            const { error: partError } = await supabase.from('chat_participants').insert([{ chat_id: newChat.id, user_id: currentUser.id }, { chat_id: newChat.id, user_id: senderId }]);
            if (partError) throw partError;

            await loadChats();
            const newPrivateChat = privateChats.find(c => c.otherUser?.id === senderId);
            if (newPrivateChat) selectChat(newPrivateChat.id, false);
            loadFriendRequests();
        } catch (error) {
            console.error('Error accepting request:', error);
            showMessage('Failed to accept request: ' + error.message, true);
        } finally {
            window._acceptingRequest = false;
        }
    };

    window.rejectRequest = async function(requestId) {
        await supabase.from('friend_requests').update({ status: 'rejected' }).eq('id', requestId);
        loadFriendRequests();
    };

    function renderRequests() {
        if (!requestsList) return;
        if (pendingRequests.length === 0) {
            requestsList.innerHTML = '<p class="text-xs text-bubli-dark/40 dark:text-white/40 text-center py-2">No pending requests</p>';
            return;
        }

        requestsList.innerHTML = pendingRequests.map(req => {
            const isIncoming = req.receiver_id === currentUser.id;
            if (!isIncoming) {
                return `<div class="flex items-center justify-between p-2 rounded-xl bg-bubli-accent/10"><div class="flex items-center gap-2"><img src="${req.receiver.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${req.receiver.username}`}" class="w-6 h-6 rounded-full"><span class="text-xs font-medium truncate">${req.receiver.username}</span></div><span class="text-xs text-bubli-dark/40 flex-shrink-0">Pending</span></div>`;
            } else {
                return `<div onclick="openRequestModal('${req.id}', '${req.sender_id}', '${req.sender.username}', '${req.sender.avatar_url || ''}')" class="flex items-center justify-between p-2 rounded-xl bg-bubli-accent/10 cursor-pointer hover:bg-bubli-accent/20 transition-colors"><div class="flex items-center gap-2"><img src="${req.sender.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${req.sender.username}`}" class="w-6 h-6 rounded-full"><span class="text-xs font-medium truncate">${req.sender.username}</span></div><span class="text-xs bg-bubli-primary text-white px-2 py-0.5 rounded-full">New</span></div>`;
            }
        }).join('');
    }

    window.openRequestModal = function(requestId, senderId, senderUsername, senderAvatar) {
        currentRequestId = requestId;
        currentRequestSenderId = senderId;
        document.getElementById('request-avatar').src = senderAvatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${senderUsername}`;
        document.getElementById('request-username').textContent = senderUsername;
        document.getElementById('request-modal').classList.remove('hidden');
        document.getElementById('request-modal').classList.add('flex');
    };

    window.closeRequestModal = function() {
        document.getElementById('request-modal').classList.add('hidden');
        document.getElementById('request-modal').classList.remove('flex');
        currentRequestId = null;
        currentRequestSenderId = null;
    };

    // ---------- Chat Logic ----------
    window.selectChat = async function(chatId, isGroup) {
        // Clean up old subscriptions related to specific chat rooms
        activeSubscriptions.forEach(sub => {
            if (sub.topic?.includes('chat:') || sub.topic?.includes('typing:')) {
                if (!sub.topic.includes('online-users')) sub.unsubscribe();
            }
        });
        activeSubscriptions = activeSubscriptions.filter(s => !s.topic?.includes('chat:') && !s.topic?.includes('typing:'));

        const chat = isGroup ? groupChats.find(c => c.id == chatId) : privateChats.find(c => c.id == chatId);
        currentChat = chat;
        if(!currentChat) return;

        const { data: msgs } = await supabase.from('messages').select('*, sender:profiles!sender_id(username, avatar_url)').eq('chat_id', chatId).order('created_at', { ascending: true });
        messages = msgs || [];
        renderMessages();

        const messagesSubscription = supabase.channel(`chat:${chatId}`)
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${chatId}` }, async (payload) => {
                const newMsg = payload.new;
                const { data: senderProfile } = await supabase.from('profiles').select('username, avatar_url').eq('id', newMsg.sender_id).single();
                newMsg.sender = senderProfile || { username: 'Unknown' };
                messages.push(newMsg);
                renderMessages();
                if (document.hidden && newMsg.sender_id !== currentUser.id) playNotificationSound();
                const targetChat = [...privateChats, ...groupChats].find(c => c.id === chatId);
                if (targetChat) { targetChat.lastMessage = newMsg; renderChatLists(); }
            })
            .subscribe();
        activeSubscriptions.push(messagesSubscription);

        const typingChannel = supabase.channel(`typing:${chatId}`, { config: { broadcast: { self: true } } });
        typingChannel.on('broadcast', { event: 'typing' }, ({ payload }) => {
            if (payload.user_id !== currentUser.id) showTypingIndicator(payload.username);
        }).subscribe();
        activeSubscriptions.push(typingChannel);

        renderChatHeader();
        if (window.innerWidth < 768) toggleMobileSidebar();
    };

    function playNotificationSound() { new Audio('https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3').play().catch(() => {}); }

    let typingTimeout;
    function showTypingIndicator(username) {
        typingText.textContent = `${username} is typing...`;
        typingIndicator.classList.remove('hidden');
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => typingIndicator.classList.add('hidden'), 3000);
    }

    window.sendTyping = function() {
        if (!currentChat) return;
        const typingChannel = activeSubscriptions.find(s => s.topic === `typing:${currentChat.id}`);
        if (typingChannel) typingChannel.send({ type: 'broadcast', event: 'typing', payload: { user_id: currentUser.id, username: currentProfile.username } });
    };

    function renderChatHeader() {
        if (!currentChat) return;
        const isGroup = currentChat.is_group;
        const presenceState = activeSubscriptions.find(s => s.topic?.startsWith('presence:online-users'))?.presenceState() || {};
        const otherUserId = currentChat.otherUser?.id;
        const isOnline = !isGroup && otherUserId && !!presenceState[otherUserId];

        // Reset action button
        headerActionBtn.className = "btn-profile ml-auto px-4 py-2 rounded-xl font-display font-600 text-sm text-bubli-primary dark:text-bubli-light flex items-center gap-2 transition-opacity";
        headerActionBtn.onclick = null;

        if (isGroup) {
            headerActionBtn.classList.add('opacity-0', 'pointer-events-none'); // Hide for groups
        } else {
            headerActionBtn.classList.remove('opacity-0', 'pointer-events-none');
            headerActionBtn.onclick = () => viewProfile(otherUserId);
        }

        chatHeaderContent.innerHTML = `
            <div class="flex items-center gap-3 flex-1 min-w-0">
                ${isGroup ? `
                    <div class="flex -space-x-2 flex-shrink-0">
                        ${currentChat.members.slice(0, 3).map(m => `<img src="${m.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${m.username}`}" class="w-9 h-9 rounded-full border-2 border-white dark:border-[#2D2640]">`).join('')}
                    </div>
                ` : `
                    <div class="relative flex-shrink-0">
                        <img src="${currentChat.otherUser?.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentChat.otherUser?.username}`}" class="w-10 h-10 rounded-full">
                        <span id="chat-header-online-dot" class="absolute bottom-0 right-0 w-3.5 h-3.5 rounded-full border-2 border-white dark:border-[#231E33] ${isOnline ? 'bg-green-500 is-online' : 'bg-gray-400'}"></span>
                    </div>
                `}
                <div class="flex-1 min-w-0">
                    <h2 class="font-display font-700 truncate">${isGroup ? (currentChat.name || 'Group Chat') : currentChat.otherUser?.username}</h2>
                    <p id="chat-header-status" class="text-xs ${isGroup ? '' : (isOnline ? 'text-green-500' : 'text-gray-500')}">${isGroup ? `${currentChat.members.length} members` : (isOnline ? 'Online' : 'Offline')}</p>
                </div>
            </div>
        `;
    }

    function renderMessages() {
        messagesContainer.innerHTML = messages.map(msg => {
            const isOwn = msg.sender_id === currentUser.id;
            const avatarUrl = msg.sender?.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${msg.sender_id}`;
            const senderName = msg.sender?.username || 'Unknown';
            return `
                <div class="flex ${isOwn ? 'justify-end' : 'justify-start'} animate-message-in">
                    ${!isOwn ? `<button onclick="viewProfile('${msg.sender_id}')" class="flex-shrink-0 mr-2 self-end"><img src="${avatarUrl}" class="w-8 h-8 rounded-full"></button>` : ''}
                    <div class="max-w-[75%] sm:max-w-[60%]">
                        ${!isOwn ? `<p class="text-xs font-semibold text-bubli-primary dark:text-bubli-light mb-1 ml-1">${senderName}</p>` : ''}
                        <div class="message-bubble ${isOwn ? 'message-own' : 'message-other'} px-4 py-2.5">
                            <p class="text-sm ${isOwn ? 'text-white' : 'text-bubli-dark dark:text-white'}">${msg.content}</p>
                        </div>
                        <div class="flex items-center gap-2 mt-1 ${isOwn ? 'justify-end' : 'justify-start'} px-1">
                            <span class="text-xs text-bubli-dark/40 dark:text-white/40">${new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                            ${isOwn ? `<svg class="w-3.5 h-3.5 text-bubli-accent" fill="currentColor" viewBox="0 0 24 24"><path d="M18 7l-1.41-1.41-6.34 6.34 1.41 1.41L18 7zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12-1.42-1.41zM.41 13.41L6 19l1.41-1.41L1.83 12 .41 13.41z"/></svg>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    window.sendMessage = async function() {
        const text = messageInput.value.trim();
        if (!text || !currentChat) return;
        await supabase.from('messages').insert({ chat_id: currentChat.id, sender_id: currentUser.id, content: text, created_at: new Date().toISOString() });
        messageInput.value = '';
        messageInput.style.height = 'auto';
    };

    window.toggleEmojiPicker = () => emojiPicker.classList.toggle('hidden');
    window.insertEmoji = (emoji) => { messageInput.value += emoji; messageInput.focus(); toggleEmojiPicker(); };
    function renderEmojiPicker() { emojiGrid.innerHTML = emojis.map(e => `<button class="emoji-btn w-8 h-8 flex items-center justify-center rounded hover:bg-bubli-accent/20 text-base" onclick="insertEmoji('${e}')">${e}</button>`).join(''); }

    window.viewProfile = async function(userId) {
        if (!userId) return;
        const { data: profile } = await supabase.from('profiles').select('*').eq('id', userId).single();
        if (!profile) return;

        const { data: mutualChats } = await supabase.from('chat_participants').select('chat_id').eq('user_id', currentUser.id);
        const userChats = await supabase.from('chat_participants').select('chat_id').eq('user_id', userId);
        const mutualChatIds = mutualChats?.map(c => c.chat_id).filter(id => userChats.data?.some(uc => uc.chat_id === id)) || [];
        const { count: messageCount } = await supabase.from('messages').select('*', { count: 'exact', head: true }).in('chat_id', mutualChatIds);
        
        const presenceState = activeSubscriptions.find(s => s.topic?.startsWith('presence:online-users'))?.presenceState() || {};
        const isOnline = !!presenceState[userId];

        document.getElementById('profile-name').textContent = profile.username;
        document.getElementById('profile-avatar').src = profile.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${profile.username}`;
        document.getElementById('profile-status-text').textContent = isOnline ? 'Online' : 'Offline';
        document.getElementById('profile-messages').textContent = messageCount || '0';
        document.getElementById('profile-chats').textContent = mutualChatIds.length.toString();

        profileModal.classList.remove('hidden');
        profileModal.classList.add('flex');
    };

    window.closeProfile = () => { profileModal.classList.add('hidden'); profileModal.classList.remove('flex'); };
    window.startDirectChat = () => { closeProfile(); const existingChat = privateChats.find(c => c.otherUser?.username === document.getElementById('profile-name').textContent); if (existingChat) selectChat(existingChat.id, false); else showMessage('You need to be friends to start a chat'); };

    window.toggleMobileSidebar = () => { sidebar.classList.toggle('active'); sidebarOverlay.classList.toggle('active'); };
    window.toggleTheme = () => document.documentElement.classList.toggle('dark');
    window.autoResize = (textarea) => { textarea.style.height = 'auto'; textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px'; };
    window.handleKeyDown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } sendTyping(); };

    async function init() {
        await loadCurrentUser();
        await loadChats();
        await loadFriendRequests();
        renderEmojiPicker();
        subscribeToChatChanges();

        supabase.channel('friend_requests').on('postgres_changes', { event: '*', schema: 'public', table: 'friend_requests', filter: `receiver_id=eq.${currentUser.id}` }, loadFriendRequests).subscribe();

        document.getElementById('accept-request-btn').addEventListener('click', async () => {
            const btn = document.getElementById('accept-request-btn');
            if (btn.disabled) return;
            btn.disabled = true;
            try { if (currentRequestId && currentRequestSenderId) { await acceptRequest(currentRequestId, currentRequestSenderId); closeRequestModal(); } } 
            finally { btn.disabled = false; }
        });

        document.getElementById('reject-request-btn').addEventListener('click', async () => { if (currentRequestId) { await rejectRequest(currentRequestId); closeRequestModal(); } });

        document.addEventListener('click', (e) => { if (!emojiPicker.contains(e.target) && !e.target.closest('[onclick="toggleEmojiPicker()"]')) emojiPicker.classList.add('hidden'); });
        profileModal.addEventListener('click', (e) => { if (e.target === profileModal) closeProfile(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeProfile(); closeRequestModal(); emojiPicker.classList.add('hidden'); } });
    }

    init();
</script>
</body>
</html>