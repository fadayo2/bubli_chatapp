<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bubli - Chat. Play. Connect.</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            bubli: {
              primary: '#7B5BE4',
              light: '#C9B7FF',
              dark: '#5A3DC7',
              cream: '#FAF8FF',
              accent: '#E8DFFF',
              glow: '#9D8AFF'
            }
          },
          fontFamily: {
            display: ['Nunito', 'sans-serif'],
            body: ['DM Sans', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style>
    :root {
      --bg: #FAF8FF;
      --fg: #2D2847;
      --muted: #6B6488;
      --accent: #7B5BE4;
      --accent-light: #C9B7FF;
      --card: #FFFFFF;
      --border: #E8E4F0;
      --sidebar: #F5F0FF;
      --bubble-own: #7B5BE4;
      --bubble-other: #FFFFFF;
    }

    .dark {
      --bg: #1A1625;
      --fg: #F5F0FF;
      --muted: #9D8AFF;
      --accent: #9D8AFF;
      --accent-light: #5A3DC7;
      --card: #2D2640;
      --border: #3D3555;
      --sidebar: #231E33;
      --bubble-own: #7B5BE4;
      --bubble-other: #2D2640;
    }

    * { box-sizing: border-box; }
    
    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--fg);
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .font-display { font-family: 'Nunito', sans-serif; }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--accent-light); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

    @keyframes float { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-15px) rotate(3deg); } }
    @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(1.3); opacity: 1; } }
    @keyframes typing { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }
    @keyframes messageIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 50% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; } }
    @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }

    .animate-float { animation: float 8s ease-in-out infinite; }
    .animate-pulse-soft { animation: pulse 2s ease-in-out infinite; }
    .typing-dot { animation: typing 1.4s ease-in-out infinite; }
    .typing-dot:nth-child(2) { animation-delay: 0.15s; }
    .typing-dot:nth-child(3) { animation-delay: 0.3s; }
    .animate-message-in { animation: messageIn 0.3s ease-out; }
    .animate-pop-in { animation: popIn 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    
    /* 3D Animation Container */
    .effect-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
      overflow: hidden;
    }

    .shape-3d {
      position: absolute;
      width: 50px;
      height: 50px;
      transform-style: preserve-3d;
      animation: float3d 4s infinite ease-in-out;
    }

    @keyframes float3d {
      0%, 100% { transform: translateY(0) rotateX(0deg) rotateY(0deg); }
      50% { transform: translateY(-30px) rotateX(180deg) rotateY(180deg); }
    }

    .cube {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      animation: spin 6s infinite linear;
    }

    @keyframes spin {
      from { transform: rotateX(0deg) rotateY(0deg); }
      to { transform: rotateX(360deg) rotateY(360deg); }
    }

    .cube div {
      position: absolute;
      width: 100%;
      height: 100%;
      background: rgba(123, 91, 228, 0.8);
      border: 2px solid white;
      box-shadow: 0 0 20px rgba(123, 91, 228, 0.5);
    }

    .cube .front { transform: translateZ(25px); }
    .cube .back { transform: rotateY(180deg) translateZ(25px); }
    .cube .right { transform: rotateY(90deg) translateZ(25px); }
    .cube .left { transform: rotateY(-90deg) translateZ(25px); }
    .cube .top { transform: rotateX(90deg) translateZ(25px); }
    .cube .bottom { transform: rotateX(-90deg) translateZ(25px); }

    .sphere {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ff6b6b, #ff1493);
      box-shadow: 0 0 30px #ff1493;
      transform-style: preserve-3d;
      animation: pulse3d 2s infinite alternate;
    }

    @keyframes pulse3d {
      0% { transform: scale(1) rotateX(0deg); }
      100% { transform: scale(1.3) rotateX(360deg); }
    }

    .ring {
      width: 60px;
      height: 60px;
      border: 4px solid gold;
      border-radius: 50%;
      transform-style: preserve-3d;
      animation: rotateRing 3s infinite linear;
    }

    @keyframes rotateRing {
      from { transform: rotateX(0deg) rotateY(0deg); }
      to { transform: rotateX(360deg) rotateY(360deg); }
    }

    .star {
      width: 0;
      height: 0;
      border-left: 25px solid transparent;
      border-right: 25px solid transparent;
      border-bottom: 40px solid gold;
      position: relative;
      transform-style: preserve-3d;
      animation: twinkle 1.5s infinite alternate;
    }

    @keyframes twinkle {
      0% { opacity: 0.2; transform: scale(0.8) rotateY(0deg); }
      100% { opacity: 1; transform: scale(1.2) rotateY(180deg); }
    }

    .star:after {
      content: '';
      position: absolute;
      top: 12px;
      left: -25px;
      width: 0;
      height: 0;
      border-left: 25px solid transparent;
      border-right: 25px solid transparent;
      border-top: 40px solid gold;
    }

    /* Reaction button */
    .reaction-trigger {
      opacity: 0;
      transition: opacity 0.2s ease;
      cursor: pointer;
      font-size: 1.2rem;
      line-height: 1;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .message-wrapper:hover .reaction-trigger {
      opacity: 1;
    }
    .reaction-badge {
      display: inline-flex;
      align-items: center;
      gap: 2px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .reaction-badge.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    .reaction-badge:hover {
      transform: scale(1.05);
    }
    .reaction-picker {
      position: absolute;
      z-index: 40;
      display: flex;
      gap: 4px;
      padding: 8px;
      border-radius: 999px;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: 0 10px 40px rgba(123, 91, 228, 0.2);
    }

    .message-bubble { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .message-bubble:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(123, 91, 228, 0.15); }
    .message-own { background: linear-gradient(135deg, #7B5BE4 0%, #9D8AFF 100%); border-radius: 20px 20px 6px 20px; }
    .message-other { background: var(--bubble-other); border-radius: 20px 20px 20px 6px; box-shadow: 0 2px 8px rgba(123, 91, 228, 0.08); }
    .dark .message-other { box-shadow: none; border: 1px solid var(--border); }

    .sidebar-item { transition: all 0.2s ease; border-left: 3px solid transparent; }
    .sidebar-item:hover { background: rgba(123, 91, 228, 0.08); border-left-color: rgba(123, 91, 228, 0.3); }
    .sidebar-item.active { background: linear-gradient(90deg, rgba(123, 91, 228, 0.15) 0%, transparent 100%); border-left-color: var(--accent); }

    .btn-send { background: linear-gradient(135deg, #7B5BE4 0%, #9D8AFF 100%); transition: all 0.2s ease; }
    .btn-send:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(123, 91, 228, 0.35); }
    .btn-send:active { transform: scale(0.95); }

    .btn-profile { transition: all 0.2s ease; }
    .btn-profile:hover { background: rgba(123, 91, 228, 0.1); transform: scale(1.02); }

    .chat-input { background: var(--card); border: 2px solid var(--border); transition: all 0.2s ease; }
    .chat-input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(123, 91, 228, 0.1); }

    .online-dot.is-online { animation: pulse 2s ease-in-out infinite; }

    .emoji-picker, .effects-picker {
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: 0 10px 40px rgba(123, 91, 228, 0.2);
    }
    .emoji-btn, .effect-btn {
      transition: transform 0.15s ease;
      cursor: pointer;
    }
    .emoji-btn:hover, .effect-btn:hover {
      transform: scale(1.3);
    }
    .effect-btn {
      padding: 0.5rem;
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--accent-light);
      color: var(--fg);
    }
    .dark .effect-btn {
      background: var(--accent);
      color: white;
    }

    .theme-toggle { transition: transform 0.3s ease; }
    .theme-toggle:hover { transform: rotate(180deg); }

    .gradient-text { background: linear-gradient(135deg, #7B5BE4 0%, #5A3DC7 50%, #9D8AFF 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }

    .modal-overlay { background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); }
    .modal-content { background: var(--card); box-shadow: 0 25px 50px rgba(123, 91, 228, 0.25); }

    @media (max-width: 768px) {
      .sidebar-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 40; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
      .sidebar-overlay.active { opacity: 1; pointer-events: auto; }
      .sidebar-mobile { transform: translateX(-100%); transition: transform 0.3s ease; }
      .sidebar-mobile.active { transform: translateX(0); }
    }

    .floating-bubble { position: absolute; border-radius: 50%; pointer-events: none; opacity: 0.08; }

    /* Input area fixed at bottom */
    .input-area {
      flex-shrink: 0;
      padding: 1rem;
      border-top: 1px solid var(--border);
      background: var(--card);
      transition: opacity 0.3s ease;
    }
    .input-area.hidden {
      opacity: 0;
      pointer-events: none;
    }
    .main-content {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }
  </style>
</head>
<body class="dark:bg-[#1A1625]">
  <!-- Floating Background -->
  <div class="fixed inset-0 pointer-events-none overflow-hidden z-0">
    <div class="floating-bubble w-40 h-40 bg-bubli-primary top-20 left-20 animate-float" style="animation-duration: 12s;"></div>
    <div class="floating-bubble w-28 h-28 bg-bubli-light top-1/3 right-24 animate-float" style="animation-duration: 16s; animation-delay: 2s;"></div>
    <div class="floating-bubble w-20 h-20 bg-bubli-glow bottom-32 left-1/4 animate-float" style="animation-duration: 14s; animation-delay: 4s;"></div>
  </div>

  <!-- 3D Effect Container -->
  <div id="effect-container" class="effect-container"></div>

  <div class="flex-1 flex relative z-10 overflow-hidden">
    <div class="sidebar-overlay md:hidden" id="sidebar-overlay" onclick="toggleMobileSidebar()"></div>

    <!-- Sidebar -->
    <aside class="sidebar-mobile md:transform-none fixed md:relative z-50 md:z-auto w-80 h-full flex flex-col border-r border-bubli-accent/20 dark:border-[#3D3555]" style="background: var(--sidebar);" id="sidebar">
      <!-- Sidebar Header -->
      <div class="p-4 border-b border-bubli-accent/20 dark:border-[#3D3555]">
        <div class="flex items-center justify-between mb-4">
          <a href="#" class="flex items-center gap-2 group">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-bubli-primary to-bubli-glow flex items-center justify-center shadow-lg group-hover:scale-105 transition-transform">
              <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="8" fill="white"/><circle cx="9" cy="10" r="1.5" fill="#7B5BE4"/><circle cx="15" cy="10" r="1.5" fill="#7B5BE4"/><path d="M9 14c1 1.5 5 1.5 6 0" stroke="#7B5BE4" stroke-width="1.5" stroke-linecap="round"/></svg>
            </div>
            <span class="font-display font-800 text-xl gradient-text dark:text-white">Bubli</span>
          </a>
          <button onclick="toggleTheme()" class="theme-toggle p-2 rounded-lg hover:bg-bubli-accent/20 transition-colors" aria-label="Toggle theme">
            <svg class="w-5 h-5 text-bubli-primary dark:text-bubli-light dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
            <svg class="w-5 h-5 text-bubli-light hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
          </button>
        </div>

        <!-- Search -->
        <div class="relative mb-2">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-bubli-dark/40 dark:text-white/40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
          <input type="text" placeholder="Search chats..." class="w-full pl-10 pr-4 py-2.5 rounded-xl bg-bubli-accent/20 dark:bg-[#2D2640] border-0 outline-none text-sm text-bubli-dark dark:text-white placeholder-bubli-dark/40 focus:ring-2 focus:ring-bubli-primary/50">
        </div>

        <!-- Add Friend -->
        <div class="flex items-center gap-2 mb-2">
          <input type="text" id="friend-username" placeholder="Add friend by username..." class="flex-1 px-3 py-2 text-sm rounded-xl bg-bubli-accent/20 dark:bg-[#2D2640] border-0 outline-none focus:ring-2 focus:ring-bubli-primary/50">
          <button onclick="sendFriendRequest()" class="px-3 py-2 rounded-xl bg-bubli-primary text-white text-sm font-semibold hover:bg-bubli-dark transition shadow-sm">Add</button>
        </div>

        <!-- Friend Requests -->
        <div class="border-t border-bubli-accent/20 dark:border-[#3D3555] pt-2 mt-2">
          <h3 class="text-xs font-display font-700 text-bubli-dark/50 dark:text-white/50 uppercase tracking-wider mb-2">Requests</h3>
          <div id="requests-list" class="space-y-2 max-h-32 overflow-y-auto"></div>
        </div>
      </div>

      <!-- Chat List -->
      <div class="flex-1 overflow-y-auto p-2">
        <div class="mb-4">
          <h3 class="px-3 py-2 text-xs font-display font-700 text-bubli-dark/50 dark:text-white/50 uppercase tracking-wider">Private Chats</h3>
          <div id="private-chats-list"></div>
        </div>
        <div>
          <h3 class="px-3 py-2 text-xs font-display font-700 text-bubli-dark/50 dark:text-white/50 uppercase tracking-wider">Group Chats</h3>
          <div id="group-chats-list"></div>
        </div>
      </div>

      <!-- User Profile Trigger -->
      <div class="p-4 border-t border-bubli-accent/20 dark:border-[#3D3550]" style="background: var(--card);">
        <button id="sidebar-profile-btn" class="w-full flex items-center gap-3 p-2 rounded-xl hover:bg-bubli-accent/10 transition-colors">
          <div class="relative">
            <img id="current-user-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=You&backgroundColor=c0aede" alt="Your avatar" class="w-10 h-10 rounded-full">
            <span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white dark:border-[#2D2640] online-dot is-online"></span>
          </div>
          <div class="flex-1 text-left">
            <p id="current-user-name" class="font-display font-700 text-sm text-bubli-dark dark:text-white">Loading...</p>
            <p class="text-xs text-green-500">Online</p>
          </div>
          <svg class="w-4 h-4 text-bubli-dark/30 dark:text-white/30" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
        </button>
      </div>
    </aside>

    <!-- Main Chat Area -->
    <main class="flex-1 flex flex-col min-w-0" style="background: var(--bg);">
      <!-- Chat Header -->
      <header class="flex-shrink-0 flex items-center gap-3 p-4 border-b border-bubli-accent/20 dark:border-[#3D3550]" style="background: var(--card);">
        <button class="md:hidden p-2 rounded-lg hover:bg-bubli-accent/20 transition-colors" onclick="toggleMobileSidebar()" aria-label="Open menu">
          <svg class="w-5 h-5 text-bubli-dark dark:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
        </button>
        
        <div id="chat-header-content" class="flex-1"></div>

        <button id="header-action-btn" class="btn-profile ml-auto px-4 py-2 rounded-xl font-display font-600 text-sm text-bubli-primary dark:text-bubli-light flex items-center gap-2 opacity-0 pointer-events-none transition-opacity">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
          <span class="hidden sm:inline">View Profile</span>
        </button>
      </header>

      <!-- Messages Area -->
      <div class="flex-1 overflow-y-auto p-4 space-y-3 main-content" id="messages-container">
        <div class="h-full flex flex-col items-center justify-center text-center px-4 animate-fade-up">
          <div class="w-20 h-20 rounded-full bg-bubli-accent/20 flex items-center justify-center mb-4">
            <svg class="w-10 h-10 text-bubli-primary/60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
          </div>
          <h3 class="font-display font-800 text-lg text-bubli-dark dark:text-white mb-1">Welcome to Bubli!</h3>
          <p class="text-sm text-bubli-dark/50 dark:text-white/50 max-w-xs">Select a chat or add a friend to start.</p>
        </div>
      </div>

      <!-- Typing Indicator -->
      <div class="flex-shrink-0 px-4 pb-2 h-6" id="typing-container">
        <div class="hidden items-center gap-2 text-sm text-bubli-dark/50 dark:text-white/50" id="typing-indicator">
          <div class="flex gap-1">
            <div class="w-1.5 h-1.5 rounded-full bg-bubli-primary typing-dot"></div>
            <div class="w-1.5 h-1.5 rounded-full bg-bubli-primary typing-dot"></div>
            <div class="w-1.5 h-1.5 rounded-full bg-bubli-primary typing-dot"></div>
          </div>
          <span id="typing-text">Someone is typing...</span>
        </div>
      </div>

      <!-- Message Input & Effects -->
      <div class="input-area" id="input-area">
        <div class="flex items-end gap-2">
          <!-- Effects button -->
          <div class="relative">
            <button onclick="toggleEffectsPicker()" class="flex-shrink-0 p-3 rounded-xl hover:bg-bubli-accent/20 transition-colors" aria-label="Add effect">
              <svg class="w-5 h-5 text-bubli-dark/50 dark:text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg>
            </button>
            <div id="effects-picker" class="effects-picker absolute bottom-12 left-0 w-48 rounded-2xl p-3 hidden z-50 animate-pop-in">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-display font-700 text-sm text-bubli-dark dark:text-white">Effects</h4>
                <button onclick="toggleEffectsPicker()" class="p-1 rounded hover:bg-bubli-accent/20"><svg class="w-4 h-4 text-bubli-dark/50 dark:text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
              </div>
              <div class="grid grid-cols-2 gap-2">
                <button class="effect-btn" onclick="triggerEffect('party')">üéâ Party</button>
                <button class="effect-btn" onclick="triggerEffect('fireworks')">üéÜ Fireworks</button>
                <button class="effect-btn" onclick="triggerEffect('hearts')">‚ù§Ô∏è Hearts</button>
                <button class="effect-btn" onclick="triggerEffect('rainbow')">üåà Rainbow</button>
                <button class="effect-btn" onclick="triggerEffect('stars')">‚≠ê Stars</button>
                <button class="effect-btn" onclick="triggerEffect('sparkle')">‚ú® Sparkle</button>
              </div>
            </div>
          </div>

          <!-- Emoji button -->
          <div class="relative">
            <button onclick="toggleEmojiPicker()" class="flex-shrink-0 p-3 rounded-xl hover:bg-bubli-accent/20 transition-colors" aria-label="Add emoji">
              <svg class="w-5 h-5 text-bubli-dark/50 dark:text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </button>
            <div class="emoji-picker absolute bottom-12 left-0 w-72 rounded-2xl p-3 hidden z-50 animate-pop-in" id="emoji-picker">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-display font-700 text-sm text-bubli-dark dark:text-white">Emojis</h4>
                <button onclick="toggleEmojiPicker()" class="p-1 rounded hover:bg-bubli-accent/20"><svg class="w-4 h-4 text-bubli-dark/50 dark:text-white/50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
              </div>
              <div class="grid grid-cols-8 gap-0.5" id="emoji-grid"></div>
            </div>
          </div>

          <!-- Message input -->
          <div class="flex-1 relative">
            <textarea id="message-input" placeholder="Say something bubbly..." rows="1" class="chat-input w-full px-4 py-3 rounded-2xl outline-none resize-none text-bubli-dark dark:text-white placeholder-bubli-dark/40 text-sm" onkeydown="handleKeyDown(event)" oninput="autoResize(this)"></textarea>
          </div>
          <button onclick="sendMessage()" class="btn-send flex-shrink-0 p-3 rounded-xl" aria-label="Send message">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
          </button>
        </div>
      </div>
    </main>
  </div>

  <!-- Profile Modal (unchanged) -->
  <div class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center p-4" id="profile-modal">
    <div class="modal-content rounded-3xl p-6 w-full max-w-md animate-pop-in">
      <div class="text-center">
        <div class="relative inline-block mb-3">
          <img id="profile-avatar" src="" alt="Profile" class="w-24 h-24 rounded-full border-4 border-bubli-accent/30">
          <span id="profile-status-dot" class="absolute bottom-1 right-1 w-5 h-5 rounded-full border-3 border-white dark:border-[#2D2640]"></span>
        </div>
        <h3 id="profile-name" class="font-display font-800 text-2xl text-bubli-dark dark:text-white mb-1"></h3>
        <p id="profile-status-text" class="text-sm mb-2"></p>
        
        <div class="mb-4 max-w-sm mx-auto">
          <div id="profile-bio-display" class="flex items-center justify-center gap-2">
            <p class="text-sm text-bubli-dark/70 dark:text-white/70 italic"></p>
            <button id="edit-bio-btn" class="text-bubli-primary hover:text-bubli-dark transition-colors hidden">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
            </button>
          </div>
          <div id="profile-bio-edit" class="hidden">
            <textarea id="bio-textarea" rows="2" class="w-full px-3 py-2 text-sm rounded-xl bg-bubli-accent/20 dark:bg-[#2D2640] border border-bubli-accent/30 focus:outline-none focus:ring-2 focus:ring-bubli-primary/50 resize-none"></textarea>
            <div class="flex gap-2 mt-2">
              <button id="save-bio-btn" class="flex-1 py-1.5 px-3 rounded-lg bg-bubli-primary text-white text-sm font-semibold hover:bg-bubli-dark transition">Save</button>
              <button id="cancel-bio-btn" class="flex-1 py-1.5 px-3 rounded-lg border border-bubli-accent/30 text-bubli-dark dark:text-white text-sm hover:bg-bubli-accent/10 transition">Cancel</button>
            </div>
          </div>
        </div>

        <div class="bg-bubli-accent/10 dark:bg-bubli-primary/20 rounded-2xl p-4 mb-4">
          <div class="grid grid-cols-3 gap-2 text-center">
            <div>
              <p id="profile-messages" class="font-display font-800 text-2xl text-bubli-primary dark:text-bubli-light">0</p>
              <p class="text-xs text-bubli-dark/50 dark:text-white/50">Messages</p>
            </div>
            <div>
              <p id="profile-chats" class="font-display font-800 text-2xl text-bubli-primary dark:text-bubli-light">0</p>
              <p class="text-xs text-bubli-dark/50 dark:text-white/50">Shared Chats</p>
            </div>
            <div>
              <p id="profile-mutual-friends" class="font-display font-800 text-2xl text-bubli-primary dark:text-bubli-light">0</p>
              <p class="text-xs text-bubli-dark/50 dark:text-white/50">Mutual Friends</p>
            </div>
          </div>
        </div>

        <p class="text-xs text-bubli-dark/40 dark:text-white/40 mb-4" id="profile-joined"></p>

        <div class="flex gap-2">
          <button onclick="closeProfile()" class="flex-1 py-3 rounded-xl border-2 border-bubli-accent/30 font-display font-600 text-bubli-dark dark:text-white hover:bg-bubli-accent/10 transition-colors">Close</button>
          <button onclick="startDirectChat()" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-bubli-primary to-bubli-glow font-display font-600 text-white hover:shadow-lg transition-all">Send Message</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Request Modal (unchanged) -->
  <div class="modal-overlay fixed inset-0 z-50 hidden items-center justify-center p-4" id="request-modal">
    <div class="modal-content rounded-3xl p-6 w-full max-w-sm animate-pop-in">
      <div class="text-center">
        <div class="relative inline-block mb-4">
          <img id="request-avatar" src="" alt="User" class="w-20 h-20 rounded-full border-4 border-bubli-accent/30">
        </div>
        <h3 id="request-username" class="font-display font-800 text-xl text-bubli-dark dark:text-white mb-4"></h3>
        <p class="text-sm text-bubli-dark/60 dark:text-white/60 mb-6">wants to chat with you</p>
        <div class="flex gap-3">
          <button id="accept-request-btn" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-green-500 to-emerald-500 font-display font-600 text-white hover:shadow-lg transition-all flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
            Accept
          </button>
          <button id="reject-request-btn" class="flex-1 py-3 rounded-xl border-2 border-red-400 font-display font-600 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            Decline
          </button>
        </div>
        <button onclick="closeRequestModal()" class="mt-4 text-sm text-bubli-dark/40 dark:text-white/40 hover:text-bubli-primary dark:hover:text-bubli-light">Close</button>
      </div>
    </div>
  </div>

<script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    const SUPABASE_URL = 'https://yhrfzhwjheuavmsiielj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlocmZ6aHdqaGV1YXZtc2lpZWxqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MTY1ODksImV4cCI6MjA4NzI5MjU4OX0.0tHWAWqwOTs8Bw4_AtDUEOZGhuM_y0Oukm-t-BzPano';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------- Global state ----------
    let currentUser = null;
    let currentProfile = null;
    let currentChat = null;
    let privateChats = [];
    let groupChats = [];
    let pendingRequests = [];
    let messages = [];
    let messageReactions = {};
    let activeSubscriptions = [];
    let typingTimeouts = {};
    let currentOpenReactionPicker = null;

    let currentRequestId = null;
    let currentRequestSenderId = null;

    // DOM elements
    const privateChatsList = document.getElementById('private-chats-list');
    const groupChatsList = document.getElementById('group-chats-list');
    const requestsList = document.getElementById('requests-list');
    const chatHeaderContent = document.getElementById('chat-header-content');
    const headerActionBtn = document.getElementById('header-action-btn');
    const messagesContainer = document.getElementById('messages-container');
    const messageInput = document.getElementById('message-input');
    const emojiPicker = document.getElementById('emoji-picker');
    const effectsPicker = document.getElementById('effects-picker');
    const emojiGrid = document.getElementById('emoji-grid');
    const typingIndicator = document.getElementById('typing-indicator');
    const typingText = document.getElementById('typing-text');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const profileModal = document.getElementById('profile-modal');
    const friendUsernameInput = document.getElementById('friend-username');
    const inputArea = document.getElementById('input-area');
    const effectContainer = document.getElementById('effect-container');

    // Profile modal sub-elements
    const profileBioDisplay = document.getElementById('profile-bio-display');
    const profileBioEdit = document.getElementById('profile-bio-edit');
    const editBioBtn = document.getElementById('edit-bio-btn');
    const saveBioBtn = document.getElementById('save-bio-btn');
    const cancelBioBtn = document.getElementById('cancel-bio-btn');
    const bioTextarea = document.getElementById('bio-textarea');

    const emojis = ['üòÄ', 'üòÇ', 'ü•∞', 'üòé', 'ü§î', 'üòç', 'üéâ', 'üëã', '‚ù§Ô∏è', 'üî•', '‚ú®', 'üëè', 'üòä', 'ü§ó', 'üíï', 'üôå', 'üí™', 'ü•≥', 'üòÑ', 'üíñ', 'üåü', '‚ò∫Ô∏è', 'üòã', 'ü§©', 'üò∫', 'ü§≠', 'üòá', 'üôÉ', 'üòå', 'ü•∫'];
    const reactionEmojis = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üòÆ', 'üò¢', 'üò°'];

    // ---------- Helper ----------
    function showMessage(msg, isError = false) {
        const toast = document.createElement('div');
        const bg = isError ? 'bg-red-500' : 'bg-green-500';
        toast.className = `fixed top-4 right-4 ${bg} text-white px-4 py-2 rounded-xl shadow-lg z-50 animate-fade-up flex items-center gap-2`;
        toast.innerHTML = `<span class="font-semibold">${msg}</span>`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    // ---------- 3D Effects (CSS based) ----------
    function clearEffects() {
        effectContainer.innerHTML = '';
    }

    function createShape(type, color) {
        const shape = document.createElement('div');
        shape.className = 'shape-3d';
        shape.style.left = Math.random() * 100 + '%';
        shape.style.top = Math.random() * 100 + '%';
        shape.style.animationDelay = Math.random() * 2 + 's';
        shape.style.animationDuration = (3 + Math.random() * 3) + 's';

        if (type === 'cube') {
            const cube = document.createElement('div');
            cube.className = 'cube';
            for (let face of ['front', 'back', 'right', 'left', 'top', 'bottom']) {
                const div = document.createElement('div');
                div.className = face;
                div.style.background = color;
                cube.appendChild(div);
            }
            shape.appendChild(cube);
        } else if (type === 'sphere') {
            shape.className = 'sphere';
            shape.style.background = color;
        } else if (type === 'ring') {
            shape.className = 'ring';
            shape.style.borderColor = color;
        } else if (type === 'star') {
            shape.className = 'star';
            shape.style.borderBottomColor = color;
        }
        return shape;
    }

    function runEffect(effect) {
        clearEffects();
        const colors = {
            party: ['#ff6b6b', '#4ecdc4', '#ffe66d', '#c7b9ff', '#ff9f1c'],
            fireworks: ['#ff4500', '#ff8c00', '#ffd700', '#ff1493', '#00ced1'],
            hearts: ['#ff69b4', '#ff1493', '#ffb6c1', '#ff0000'],
            rainbow: ['#ff0000', '#ff7f00', '#ffff00', '#00ff00', '#0000ff', '#4b0082', '#8f00ff'],
            stars: ['#ffd700', '#ffe4b5', '#f0e68c', '#fffacd'],
            sparkle: ['#ffffff', '#f0f0f0', '#fffacd', '#e6e6fa']
        };
        const palette = colors[effect] || colors.party;

        for (let i = 0; i < 15; i++) {
            let type;
            if (effect === 'party') type = 'cube';
            else if (effect === 'fireworks') type = 'sphere';
            else if (effect === 'hearts') type = 'sphere'; // heart shape not possible with CSS, use sphere
            else if (effect === 'rainbow') type = 'ring';
            else if (effect === 'stars') type = 'star';
            else type = 'sphere';
            
            const color = palette[i % palette.length];
            const shape = createShape(type, color);
            effectContainer.appendChild(shape);
        }
        // Remove after 5 seconds
        setTimeout(clearEffects, 5000);
    }

    window.triggerEffect = function(effect) {
        if (!currentChat) {
            showMessage('Select a chat first', true);
            return;
        }
        // Broadcast to others
        const effectChannel = supabase.channel(`effects:${currentChat.id}`);
        effectChannel.subscribe((status) => {
            if (status === 'SUBSCRIBED') {
                effectChannel.send({
                    type: 'broadcast',
                    event: 'effect',
                    payload: { effect }
                });
            }
        });
        // Run locally
        runEffect(effect);
    };

    // ---------- Authentication (unchanged) ----------
    async function loadCurrentUser() {
        try {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) { window.location.href = 'signin.html'; return; }
            currentUser = session.user;

            const { data: profile, error } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
            if (error) throw error;
            currentProfile = profile;

            const avatarEl = document.getElementById('current-user-avatar');
            const nameEl = document.getElementById('current-user-name');
            if (avatarEl) avatarEl.src = profile.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${profile.username}`;
            if (nameEl) nameEl.textContent = profile.username;

            document.getElementById('sidebar-profile-btn').onclick = () => viewProfile(currentUser.id);
            setupPresence();
        } catch (err) {
            console.error('Error loading user:', err);
            showMessage('Failed to load user.', true);
            setTimeout(() => window.location.href = 'signin.html', 1500);
        }
    }

    // ---------- Presence (unchanged) ----------
    async function setupPresence() {
        const channel = supabase.channel('online-users', { config: { presence: { key: currentUser.id } } });
        channel
            .on('presence', { event: 'sync' }, () => updateOnlineStatus(channel.presenceState()))
            .subscribe(async (status) => {
                if (status === 'SUBSCRIBED') await channel.track({ online_at: new Date().toISOString() });
            });
        activeSubscriptions.push(channel);
    }

    function updateOnlineStatus(presenceState) {
        document.querySelectorAll('.chat-item[data-user-id]').forEach(el => {
            const userId = el.dataset.userId;
            const onlineDot = el.querySelector('.online-dot');
            if (onlineDot) {
                const isOnline = !!presenceState[userId];
                onlineDot.className = `online-dot absolute bottom-0 right-0 w-3.5 h-3.5 rounded-full border-2 border-white dark:border-[#231E33] ${isOnline ? 'bg-green-500 is-online' : 'bg-gray-400'}`;
            }
        });
        if (currentChat && !currentChat.is_group && currentChat.otherUser) {
            const isOnline = !!presenceState[currentChat.otherUser.id];
            const headerDot = document.getElementById('chat-header-online-dot');
            if (headerDot) {
                headerDot.className = `absolute bottom-0 right-0 w-3.5 h-3.5 rounded-full border-2 border-white dark:border-[#231E33] ${isOnline ? 'bg-green-500 is-online' : 'bg-gray-400'}`;
            }
             const statusText = document.getElementById('chat-header-status');
             if (statusText) {
                 statusText.textContent = isOnline ? 'Online' : 'Offline';
                 statusText.className = `text-xs ${isOnline ? 'text-green-500' : 'text-gray-500'}`;
             }
        }
    }

    // ---------- Load chats (unchanged) ----------
    async function loadChats() {
        if (!currentUser) return;
        const { data: participations } = await supabase.from('chat_participants').select('chat_id').eq('user_id', currentUser.id);
        if (!participations || participations.length === 0) {
            privateChats = []; groupChats = []; renderChatLists(); return;
        }
        const chatIds = participations.map(p => p.chat_id);
        const { data: chats } = await supabase.from('chats').select('*').in('id', chatIds);
        privateChats = []; groupChats = [];
        for (const chat of chats) {
            const { data: lastMsg } = await supabase.from('messages').select('content, created_at, sender_id').eq('chat_id', chat.id).order('created_at', { ascending: false }).limit(1).maybeSingle();
            chat.lastMessage = lastMsg;
            if (chat.is_group) {
                const { data: members } = await supabase.from('chat_participants').select('user_id, profiles(id, username, avatar_url)').eq('chat_id', chat.id);
                chat.members = members ? members.map(m => m.profiles) : [];
                groupChats.push(chat);
            } else {
                const { data: other } = await supabase.from('chat_participants').select('user_id, profiles(id, username, avatar_url)').eq('chat_id', chat.id).neq('user_id', currentUser.id).single();
                chat.otherUser = other?.profiles;
                privateChats.push(chat);
            }
        }
        renderChatLists();
    }

    // ---------- Subscriptions (unchanged) ----------
    function subscribeToChatChanges() {
        const chatParticipantsChannel = supabase.channel('chat-participants-changes')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat_participants', filter: `user_id=eq.${currentUser.id}` }, loadChats)
            .subscribe();
        activeSubscriptions.push(chatParticipantsChannel);
        const messagesChannel = supabase.channel('messages-changes')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, (payload) => {
                const newMsg = payload.new;
                const chat = [...privateChats, ...groupChats].find(c => c.id === newMsg.chat_id);
                if (chat) { chat.lastMessage = newMsg; renderChatLists(); }
            })
            .subscribe();
        activeSubscriptions.push(messagesChannel);
    }

    // ---------- Render chat lists (unchanged) ----------
    function renderChatLists() {
        const presenceState = activeSubscriptions.find(s => s.topic?.startsWith('presence:online-users'))?.presenceState() || {};
        if (privateChats.length === 0) {
            privateChatsList.innerHTML = `<div class="text-center text-xs text-bubli-dark/40 dark:text-white/40 py-4 px-4">No chats yet.<br>Add a friend to start!</div>`;
        } else {
            privateChatsList.innerHTML = privateChats.map(chat => {
                const otherUserId = chat.otherUser?.id;
                const isOnline = !!presenceState[otherUserId];
                const lastMsg = chat.lastMessage;
                const lastMsgText = lastMsg ? (lastMsg.sender_id === currentUser.id ? 'You: ' : '') + lastMsg.content : 'No messages yet';
                const lastMsgTime = lastMsg ? new Date(lastMsg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                return `
                    <div class="sidebar-item flex items-center gap-3 p-2 rounded-xl cursor-pointer mb-1 chat-item ${currentChat?.id === chat.id ? 'active' : ''}" onclick="selectChat('${chat.id}', false)" data-user-id="${otherUserId || ''}">
                        <div class="relative flex-shrink-0">
                            <img src="${chat.otherUser?.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${chat.otherUser?.username}`}" class="w-12 h-12 rounded-full">
                            <span class="online-dot absolute bottom-0 right-0 w-3.5 h-3.5 rounded-full border-2 border-white dark:border-[#231E33] ${isOnline ? 'bg-green-500 is-online' : 'bg-gray-400'}"></span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <p class="font-display font-600 text-sm truncate">${chat.otherUser?.username}</p>
                                <span class="text-xs text-bubli-dark/40 dark:text-white/40 flex-shrink-0 ml-2">${lastMsgTime}</span>
                            </div>
                            <p class="text-xs text-bubli-dark/50 dark:text-white/50 truncate">${lastMsgText}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }
        groupChatsList.innerHTML = groupChats.map(chat => {
            const lastMsg = chat.lastMessage;
            const lastMsgText = lastMsg ? (lastMsg.sender_id === currentUser.id ? 'You: ' : '') + lastMsg.content : 'No messages yet';
            const lastMsgTime = lastMsg ? new Date(lastMsg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            return `
                <div class="sidebar-item flex items-center gap-3 p-2 rounded-xl cursor-pointer mb-1 chat-item ${currentChat?.id === chat.id ? 'active' : ''}" onclick="selectChat('${chat.id}', true)">
                    <div class="flex -space-x-2 flex-shrink-0">
                        ${chat.members.slice(0, 3).map(m => `<img src="${m.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${m.username}`}" class="w-10 h-10 rounded-full border-2 border-white dark:border-[#231E33]">`).join('')}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <p class="font-display font-600 text-sm truncate">${chat.name || 'Group Chat'}</p>
                            <span class="text-xs text-bubli-dark/40 dark:text-white/40 flex-shrink-0 ml-2">${lastMsgTime}</span>
                        </div>
                        <p class="text-xs text-bubli-dark/50 dark:text-white/50 truncate">${lastMsgText}</p>
                    </div>
                </div>
            `;
        }).join('');
    }

    // ---------- Friend Requests (unchanged) ----------
    async function loadFriendRequests() {
        if (!currentUser) return;
        const { data: requests } = await supabase.from('friend_requests').select('*, sender:profiles!sender_id(username, avatar_url), receiver:profiles!receiver_id(username, avatar_url)').or(`receiver_id.eq.${currentUser.id},sender_id.eq.${currentUser.id}`).eq('status', 'pending');
        pendingRequests = requests || [];
        renderRequests();
    }

    window.sendFriendRequest = async function() {
        const username = friendUsernameInput?.value.trim();
        if (!username) return;
        const { data: targetUser } = await supabase.from('profiles').select('id').eq('username', username).single();
        if (!targetUser) { showMessage('User not found', true); return; }
        if (targetUser.id === currentUser.id) { showMessage('You cannot add yourself', true); return; }
        const { data: existing } = await supabase.from('friend_requests').select('id').or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${targetUser.id}),and(sender_id.eq.${targetUser.id},receiver_id.eq.${currentUser.id})`).maybeSingle();
        if (existing) { showMessage('Request already pending', true); return; }
        const { error } = await supabase.from('friend_requests').insert({ sender_id: currentUser.id, receiver_id: targetUser.id });
        if (error) { showMessage('Error sending request', true); console.error(error); } 
        else { showMessage('Friend request sent!'); friendUsernameInput.value = ''; }
    };

    window._acceptingRequest = false;

    window.acceptRequest = async function(requestId, senderId) {
        if (!currentUser) { showMessage('Session expired', true); return; }
        if (window._acceptingRequest) return;
        window._acceptingRequest = true;
        try {
            const { data: existingChats } = await supabase.from('chat_participants').select('chat_id').eq('user_id', currentUser.id);
            if (existingChats && existingChats.length > 0) {
                const chatIds = existingChats.map(c => c.chat_id);
                const { data: mutualChats } = await supabase.from('chat_participants').select('chat_id, chats!inner(is_group)').in('chat_id', chatIds).eq('user_id', senderId).eq('chats.is_group', false);
                if (mutualChats && mutualChats.length > 0) {
                    const existingChatId = mutualChats[0].chat_id;
                    await supabase.from('friend_requests').update({ status: 'accepted' }).eq('id', requestId);
                    await loadChats();
                    const chat = privateChats.find(c => c.id === existingChatId);
                    if (chat) selectChat(chat.id, false);
                    loadFriendRequests();
                    window._acceptingRequest = false;
                    return;
                }
            }
            await supabase.from('friend_requests').update({ status: 'accepted' }).eq('id', requestId);
            const { data: newChat, error: chatError } = await supabase.from('chats').insert({ is_group: false }).select().single();
            if (chatError || !newChat) throw new Error(chatError?.message || 'Chat creation failed');
            const { error: partError } = await supabase.from('chat_participants').insert([{ chat_id: newChat.id, user_id: currentUser.id }, { chat_id: newChat.id, user_id: senderId }]);
            if (partError) throw partError;
            await loadChats();
            const newPrivateChat = privateChats.find(c => c.otherUser?.id === senderId);
            if (newPrivateChat) selectChat(newPrivateChat.id, false);
            loadFriendRequests();
        } catch (error) {
            console.error('Error accepting request:', error);
            showMessage('Failed to accept request: ' + error.message, true);
        } finally {
            window._acceptingRequest = false;
        }
    };

    window.rejectRequest = async function(requestId) {
        await supabase.from('friend_requests').update({ status: 'rejected' }).eq('id', requestId);
        loadFriendRequests();
    };

    function renderRequests() {
        if (!requestsList) return;
        if (pendingRequests.length === 0) {
            requestsList.innerHTML = '<p class="text-xs text-bubli-dark/40 dark:text-white/40 text-center py-2">No pending requests</p>';
            return;
        }
        requestsList.innerHTML = pendingRequests.map(req => {
            const isIncoming = req.receiver_id === currentUser.id;
            if (!isIncoming) {
                return `<div class="flex items-center justify-between p-2 rounded-xl bg-bubli-accent/10"><div class="flex items-center gap-2"><img src="${req.receiver.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${req.receiver.username}`}" class="w-6 h-6 rounded-full"><span class="text-xs font-medium truncate">${req.receiver.username}</span></div><span class="text-xs text-bubli-dark/40 flex-shrink-0">Pending</span></div>`;
            } else {
                return `<div onclick="openRequestModal('${req.id}', '${req.sender_id}', '${req.sender.username}', '${req.sender.avatar_url || ''}')" class="flex items-center justify-between p-2 rounded-xl bg-bubli-accent/10 cursor-pointer hover:bg-bubli-accent/20 transition-colors"><div class="flex items-center gap-2"><img src="${req.sender.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${req.sender.username}`}" class="w-6 h-6 rounded-full"><span class="text-xs font-medium truncate">${req.sender.username}</span></div><span class="text-xs bg-bubli-primary text-white px-2 py-0.5 rounded-full">New</span></div>`;
            }
        }).join('');
    }

    window.openRequestModal = function(requestId, senderId, senderUsername, senderAvatar) {
        currentRequestId = requestId;
        currentRequestSenderId = senderId;
        document.getElementById('request-avatar').src = senderAvatar || `https://api.dicebear.com/7.x/avataaars/svg?seed=${senderUsername}`;
        document.getElementById('request-username').textContent = senderUsername;
        document.getElementById('request-modal').classList.remove('hidden');
        document.getElementById('request-modal').classList.add('flex');
    };

    window.closeRequestModal = function() {
        document.getElementById('request-modal').classList.add('hidden');
        document.getElementById('request-modal').classList.remove('flex');
        currentRequestId = null;
        currentRequestSenderId = null;
    };

    // ---------- Reaction UI (smart positioning) ----------
    window.openReactionPicker = function(messageId, event) {
        event.stopPropagation();
        if (currentOpenReactionPicker) {
            const oldPicker = document.getElementById(`reaction-picker-${currentOpenReactionPicker}`);
            if (oldPicker) oldPicker.remove();
        }
        const btnRect = event.target.getBoundingClientRect();
        const picker = document.createElement('div');
        picker.id = `reaction-picker-${messageId}`;
        picker.className = 'reaction-picker animate-pop-in';
        picker.innerHTML = reactionEmojis.map(emoji => 
            `<button class="text-2xl hover:scale-125 transition" onclick="toggleReaction(${messageId}, '${emoji}')">${emoji}</button>`
        ).join('');
        document.body.appendChild(picker);

        // Position picker above or below button
        const pickerRect = picker.getBoundingClientRect();
        let top = btnRect.top - pickerRect.height - 10;
        let left = btnRect.left + btnRect.width/2 - pickerRect.width/2;

        // Adjust if off-screen
        if (top < 0) top = btnRect.bottom + 10;
        if (left < 0) left = 10;
        if (left + pickerRect.width > window.innerWidth) left = window.innerWidth - pickerRect.width - 10;

        picker.style.top = top + 'px';
        picker.style.left = left + 'px';
        currentOpenReactionPicker = messageId;

        // Close when clicking outside
        setTimeout(() => {
            document.addEventListener('click', function closePicker(e) {
                if (!picker.contains(e.target) && e.target !== event.target) {
                    picker.remove();
                    document.removeEventListener('click', closePicker);
                    currentOpenReactionPicker = null;
                }
            });
        }, 0);
    };

    // ---------- Chat Logic ----------
    window.selectChat = async function(chatId, isGroup) {
        activeSubscriptions.forEach(sub => {
            if (sub.topic?.includes('chat:') || sub.topic?.includes('typing:') || sub.topic?.includes('reactions:') || sub.topic?.includes('effects:')) {
                if (!sub.topic.includes('online-users')) sub.unsubscribe();
            }
        });
        activeSubscriptions = activeSubscriptions.filter(s => !s.topic?.includes('chat:') && !s.topic?.includes('typing:') && !s.topic?.includes('reactions:') && !s.topic?.includes('effects:'));

        const chat = isGroup ? groupChats.find(c => c.id == chatId) : privateChats.find(c => c.id == chatId);
        currentChat = chat;
        if(!currentChat) return;

        inputArea.classList.remove('hidden');

        const { data: msgs } = await supabase.from('messages').select('*, sender:profiles!sender_id(username, avatar_url)').eq('chat_id', chatId).order('created_at', { ascending: true });
        messages = msgs || [];

        if (messages.length) {
            const messageIds = messages.map(m => m.id);
            const { data: reactions } = await supabase
                .from('message_reactions')
                .select('*')
                .in('message_id', messageIds);
            messageReactions = {};
            reactions?.forEach(r => {
                if (!messageReactions[r.message_id]) messageReactions[r.message_id] = [];
                messageReactions[r.message_id].push(r);
            });
        }

        renderMessages();

        const messagesSubscription = supabase.channel(`chat:${chatId}`)
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `chat_id=eq.${chatId}` }, async (payload) => {
                const newMsg = payload.new;
                const { data: senderProfile } = await supabase.from('profiles').select('username, avatar_url').eq('id', newMsg.sender_id).single();
                newMsg.sender = senderProfile || { username: 'Unknown' };
                messages.push(newMsg);
                renderMessages();
                if (document.hidden && newMsg.sender_id !== currentUser.id) {
                    playNotificationSound();
                }
                const targetChat = [...privateChats, ...groupChats].find(c => c.id === chatId);
                if (targetChat) { targetChat.lastMessage = newMsg; renderChatLists(); }
            })
            .subscribe();
        activeSubscriptions.push(messagesSubscription);

        const reactionsSubscription = supabase
            .channel(`reactions:${chatId}`)
            .on('postgres_changes', { event: '*', schema: 'public', table: 'message_reactions', filter: `message_id=in.(${messages.map(m => m.id).join(',')})` }, (payload) => {
                const { eventType, new: newReaction, old: oldReaction } = payload;
                if (eventType === 'INSERT') {
                    if (!messageReactions[newReaction.message_id]) messageReactions[newReaction.message_id] = [];
                    messageReactions[newReaction.message_id].push(newReaction);
                } else if (eventType === 'DELETE') {
                    if (messageReactions[oldReaction.message_id]) {
                        messageReactions[oldReaction.message_id] = messageReactions[oldReaction.message_id].filter(r => r.id !== oldReaction.id);
                    }
                }
                renderMessages();
            })
            .subscribe();
        activeSubscriptions.push(reactionsSubscription);

        const typingChannel = supabase.channel(`typing:${chatId}`, { config: { broadcast: { self: true } } });
        typingChannel.on('broadcast', { event: 'typing' }, ({ payload }) => {
            if (payload.user_id !== currentUser.id) showTypingIndicator(payload.username);
        }).subscribe();
        activeSubscriptions.push(typingChannel);

        // Subscribe to effects
        const effectChannel = supabase.channel(`effects:${chatId}`);
        effectChannel
            .on('broadcast', { event: 'effect' }, ({ payload }) => {
                runEffect(payload.effect);
            })
            .subscribe();
        activeSubscriptions.push(effectChannel);

        renderChatHeader();
        if (window.innerWidth < 768) toggleMobileSidebar();
    };

    // Reaction toggle (global)
    window.toggleReaction = async function(messageId, emoji) {
        if (!currentUser) return;
        const existing = messageReactions[messageId]?.find(r => r.user_id === currentUser.id && r.emoji === emoji);
        if (existing) {
            const { error } = await supabase.from('message_reactions').delete().eq('id', existing.id);
            if (error) console.error('Error deleting reaction:', error);
        } else {
            const { error } = await supabase.from('message_reactions').insert({
                message_id: messageId,
                user_id: currentUser.id,
                emoji: emoji
            });
            if (error) console.error('Error adding reaction:', error);
        }
        const picker = document.getElementById(`reaction-picker-${messageId}`);
        if (picker) picker.remove();
        currentOpenReactionPicker = null;
    };

    function playNotificationSound() {
        if (!('Audio' in window) && !('AudioContext' in window)) return;
        const audio = new Audio('https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3');
        audio.volume = 0.3;
        audio.play().catch(() => {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.frequency.value = 880;
                gainNode.gain.value = 0.1;
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.2);
            } catch (e) { console.log('Notification sound failed:', e); }
        });
    }

    let typingTimeout;
    function showTypingIndicator(username) {
        typingText.textContent = `${username} is typing...`;
        typingIndicator.classList.remove('hidden');
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => typingIndicator.classList.add('hidden'), 3000);
    }

    window.sendTyping = function() {
        if (!currentChat) return;
        const typingChannel = activeSubscriptions.find(s => s.topic === `typing:${currentChat.id}`);
        if (typingChannel) typingChannel.send({ type: 'broadcast', event: 'typing', payload: { user_id: currentUser.id, username: currentProfile.username } });
    };

    function renderChatHeader() {
        if (!currentChat) return;
        const isGroup = currentChat.is_group;
        const presenceState = activeSubscriptions.find(s => s.topic?.startsWith('presence:online-users'))?.presenceState() || {};
        const otherUserId = currentChat.otherUser?.id;
        const isOnline = !isGroup && otherUserId && !!presenceState[otherUserId];

        headerActionBtn.className = "btn-profile ml-auto px-4 py-2 rounded-xl font-display font-600 text-sm text-bubli-primary dark:text-bubli-light flex items-center gap-2 transition-opacity";
        headerActionBtn.onclick = null;

        if (isGroup) {
            headerActionBtn.classList.add('opacity-0', 'pointer-events-none');
        } else {
            headerActionBtn.classList.remove('opacity-0', 'pointer-events-none');
            headerActionBtn.onclick = () => viewProfile(otherUserId);
        }

        chatHeaderContent.innerHTML = `
            <div class="flex items-center gap-3 flex-1 min-w-0">
                ${isGroup ? `
                    <div class="flex -space-x-2 flex-shrink-0">
                        ${currentChat.members.slice(0, 3).map(m => `<img src="${m.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${m.username}`}" class="w-9 h-9 rounded-full border-2 border-white dark:border-[#2D2640]">`).join('')}
                    </div>
                ` : `
                    <div class="relative flex-shrink-0">
                        <img src="${currentChat.otherUser?.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${currentChat.otherUser?.username}`}" class="w-10 h-10 rounded-full">
                        <span id="chat-header-online-dot" class="absolute bottom-0 right-0 w-3.5 h-3.5 rounded-full border-2 border-white dark:border-[#231E33] ${isOnline ? 'bg-green-500 is-online' : 'bg-gray-400'}"></span>
                    </div>
                `}
                <div class="flex-1 min-w-0">
                    <h2 class="font-display font-700 truncate">${isGroup ? (currentChat.name || 'Group Chat') : currentChat.otherUser?.username}</h2>
                    <p id="chat-header-status" class="text-xs ${isGroup ? '' : (isOnline ? 'text-green-500' : 'text-gray-500')}">${isGroup ? `${currentChat.members.length} members` : (isOnline ? 'Online' : 'Offline')}</p>
                </div>
            </div>
        `;
    }

    function renderMessages() {
        messagesContainer.innerHTML = messages.map(msg => {
            const isOwn = msg.sender_id === currentUser.id;
            const avatarUrl = msg.sender?.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${msg.sender_id}`;
            const senderName = msg.sender?.username || 'Unknown';
            const reactions = messageReactions[msg.id] || [];
            const reactionCounts = reactions.reduce((acc, r) => {
                acc[r.emoji] = (acc[r.emoji] || 0) + 1;
                return acc;
            }, {});

            return `
                <div class="message-wrapper flex ${isOwn ? 'justify-end' : 'justify-start'} animate-message-in">
                    ${!isOwn ? `<button onclick="viewProfile('${msg.sender_id}')" class="flex-shrink-0 mr-2 self-end"><img src="${avatarUrl}" class="w-8 h-8 rounded-full"></button>` : ''}
                    <div class="max-w-[75%] sm:max-w-[60%] relative">
                        ${!isOwn ? `<p class="text-xs font-semibold text-bubli-primary dark:text-bubli-light mb-1 ml-1">${senderName}</p>` : ''}
                        <div class="message-bubble ${isOwn ? 'message-own' : 'message-other'} px-4 py-2.5">
                            <p class="text-sm ${isOwn ? 'text-white' : 'text-bubli-dark dark:text-white'}">${msg.content}</p>
                        </div>
                        <div class="flex items-center gap-2 mt-1 ${isOwn ? 'justify-end' : 'justify-start'} px-1">
                            <span class="text-xs text-bubli-dark/40 dark:text-white/40">${new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                            ${isOwn ? `<svg class="w-3.5 h-3.5 text-bubli-accent" fill="currentColor" viewBox="0 0 24 24"><path d="M18 7l-1.41-1.41-6.34 6.34 1.41 1.41L18 7zm4.24-1.41L11.66 16.17 7.48 12l-1.41 1.41L11.66 19l12-12-1.42-1.41zM.41 13.41L6 19l1.41-1.41L1.83 12 .41 13.41z"/></svg>` : ''}
                        </div>
                        <!-- Simple plus button -->
                        <button class="reaction-trigger absolute ${isOwn ? 'left-0 -ml-8' : 'right-0 -mr-8'} top-1/2 transform -translate-y-1/2" onclick="openReactionPicker(${msg.id}, event)">+</button>
                        <!-- Reaction badges -->
                        <div class="flex flex-wrap gap-1 mt-1 ${isOwn ? 'justify-end' : 'justify-start'}">
                            ${Object.entries(reactionCounts).map(([emoji, count]) => {
                                const userReacted = reactions.some(r => r.user_id === currentUser.id && r.emoji === emoji);
                                return `
                                    <span class="reaction-badge ${userReacted ? 'active' : ''}" onclick="toggleReaction(${msg.id}, '${emoji}')">
                                        ${emoji} ${count}
                                    </span>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    window.sendMessage = async function() {
        const text = messageInput.value.trim();
        if (!text || !currentChat) return;
        await supabase.from('messages').insert({ 
            chat_id: currentChat.id, 
            sender_id: currentUser.id, 
            content: text, 
            created_at: new Date().toISOString() 
        });
        messageInput.value = '';
        messageInput.style.height = 'auto';
    };

    // Emoji and Effects pickers
    window.toggleEmojiPicker = () => {
        emojiPicker.classList.toggle('hidden');
        if (!emojiPicker.classList.contains('hidden')) {
            effectsPicker.classList.add('hidden');
        }
    };
    window.toggleEffectsPicker = () => {
        effectsPicker.classList.toggle('hidden');
        if (!effectsPicker.classList.contains('hidden')) {
            emojiPicker.classList.add('hidden');
        }
    };
    window.insertEmoji = (emoji) => { messageInput.value += emoji; messageInput.focus(); };
    function renderEmojiPicker() { emojiGrid.innerHTML = emojis.map(e => `<button class="emoji-btn w-8 h-8 flex items-center justify-center rounded hover:bg-bubli-accent/20 text-base" onclick="insertEmoji('${e}')">${e}</button>`).join(''); }

    // ========== PROFILE VIEW (unchanged) ==========
    window.viewProfile = async function(userId) {
        if (!userId) return;
        const { data: profile } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', userId)
            .single();

        if (!profile) return;

        const isOwn = userId === currentUser.id;

        const { data: mutualChats } = await supabase
            .from('chat_participants')
            .select('chat_id')
            .eq('user_id', currentUser.id);

        const userChats = await supabase
            .from('chat_participants')
            .select('chat_id')
            .eq('user_id', userId);

        const mutualChatIds = mutualChats?.map(c => c.chat_id)
            .filter(id => userChats.data?.some(uc => uc.chat_id === id)) || [];

        const { count: messageCount } = await supabase
            .from('messages')
            .select('*', { count: 'exact', head: true })
            .in('chat_id', mutualChatIds);

        const { count: mutualFriendsCount } = await supabase
            .from('friend_requests')
            .select('*', { count: 'exact', head: true })
            .eq('status', 'accepted')
            .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${userId}),and(sender_id.eq.${userId},receiver_id.eq.${currentUser.id})`);

        const presenceState = activeSubscriptions.find(s => s.topic?.startsWith('presence:online-users'))?.presenceState() || {};
        const isOnline = !!presenceState[userId];

        const joinedDate = profile.created_at 
            ? new Date(profile.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })
            : 'Unknown';

        const bio = profile.bio || 'No bio yet.';

        document.getElementById('profile-name').textContent = profile.username;
        document.getElementById('profile-avatar').src = profile.avatar_url || `https://api.dicebear.com/7.x/avataaars/svg?seed=${profile.username}`;
        
        const statusDot = document.getElementById('profile-status-dot');
        const statusText = document.getElementById('profile-status-text');
        if (isOnline) {
            statusDot.className = 'absolute bottom-1 right-1 w-5 h-5 rounded-full border-3 border-white dark:border-[#2D2640] bg-green-500';
            statusText.textContent = 'Online';
            statusText.className = 'text-sm text-green-500 mb-2';
        } else {
            statusDot.className = 'absolute bottom-1 right-1 w-5 h-5 rounded-full border-3 border-white dark:border-[#2D2640] bg-gray-400';
            statusText.textContent = 'Offline';
            statusText.className = 'text-sm text-gray-500 mb-2';
        }

        const bioDisplayP = profileBioDisplay.querySelector('p');
        bioDisplayP.textContent = bio;
        bioTextarea.value = bio;

        if (isOwn) {
            editBioBtn.classList.remove('hidden');
            profileBioDisplay.classList.remove('hidden');
            profileBioEdit.classList.add('hidden');
        } else {
            editBioBtn.classList.add('hidden');
            profileBioDisplay.classList.remove('hidden');
            profileBioEdit.classList.add('hidden');
        }

        document.getElementById('profile-messages').textContent = messageCount || '0';
        document.getElementById('profile-chats').textContent = mutualChatIds.length.toString();
        document.getElementById('profile-mutual-friends').textContent = mutualFriendsCount || '0';
        document.getElementById('profile-joined').textContent = `Joined ${joinedDate}`;

        profileModal.classList.remove('hidden');
        profileModal.classList.add('flex');
    };

    // Bio edit handlers (unchanged)
    editBioBtn.addEventListener('click', () => {
        profileBioDisplay.classList.add('hidden');
        profileBioEdit.classList.remove('hidden');
    });

    cancelBioBtn.addEventListener('click', () => {
        profileBioDisplay.classList.remove('hidden');
        profileBioEdit.classList.add('hidden');
        const originalBio = profileBioDisplay.querySelector('p').textContent;
        bioTextarea.value = originalBio;
    });

    saveBioBtn.addEventListener('click', async () => {
        const newBio = bioTextarea.value.trim();
        if (newBio === currentProfile.bio) {
            cancelBioBtn.click();
            return;
        }
        const { error } = await supabase
            .from('profiles')
            .update({ bio: newBio })
            .eq('id', currentUser.id);
        if (error) {
            showMessage('Failed to update bio', true);
            console.error(error);
        } else {
            currentProfile.bio = newBio;
            profileBioDisplay.querySelector('p').textContent = newBio || 'No bio yet.';
            showMessage('Bio updated!');
        }
        profileBioDisplay.classList.remove('hidden');
        profileBioEdit.classList.add('hidden');
    });

    window.closeProfile = () => { profileModal.classList.add('hidden'); profileModal.classList.remove('flex'); };
    window.startDirectChat = () => { closeProfile(); const existingChat = privateChats.find(c => c.otherUser?.username === document.getElementById('profile-name').textContent); if (existingChat) selectChat(existingChat.id, false); else showMessage('You need to be friends to start a chat'); };

    window.toggleMobileSidebar = () => { sidebar.classList.toggle('active'); sidebarOverlay.classList.toggle('active'); };
    window.toggleTheme = () => document.documentElement.classList.toggle('dark');
    window.autoResize = (textarea) => { textarea.style.height = 'auto'; textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px'; };
    window.handleKeyDown = (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } sendTyping(); };

    async function init() {
        await loadCurrentUser();
        await loadChats();
        await loadFriendRequests();
        renderEmojiPicker();
        subscribeToChatChanges();

        inputArea.classList.add('hidden');

        supabase.channel('friend_requests').on('postgres_changes', { event: '*', schema: 'public', table: 'friend_requests', filter: `receiver_id=eq.${currentUser.id}` }, loadFriendRequests).subscribe();

        document.getElementById('accept-request-btn').addEventListener('click', async () => {
            const btn = document.getElementById('accept-request-btn');
            if (btn.disabled) return;
            btn.disabled = true;
            try { if (currentRequestId && currentRequestSenderId) { await acceptRequest(currentRequestId, currentRequestSenderId); closeRequestModal(); } } 
            finally { btn.disabled = false; }
        });

        document.getElementById('reject-request-btn').addEventListener('click', async () => { if (currentRequestId) { await rejectRequest(currentRequestId); closeRequestModal(); } });

        document.addEventListener('click', (e) => {
            if (!emojiPicker.contains(e.target) && !e.target.closest('[onclick="toggleEmojiPicker()"]')) emojiPicker.classList.add('hidden');
            if (!effectsPicker.contains(e.target) && !e.target.closest('[onclick="toggleEffectsPicker()"]')) effectsPicker.classList.add('hidden');
        });
        profileModal.addEventListener('click', (e) => { if (e.target === profileModal) closeProfile(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeProfile(); closeRequestModal(); emojiPicker.classList.add('hidden'); effectsPicker.classList.add('hidden'); } });
    }

    init();
</script>

<!-- Database upgrade instructions -->
<!--
Run this SQL in your Supabase SQL editor:

ALTER TABLE profiles ADD COLUMN IF NOT EXISTS bio TEXT;
CREATE TABLE IF NOT EXISTS message_reactions (
  id BIGSERIAL PRIMARY KEY,
  message_id BIGINT NOT NULL REFERENCES messages(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  emoji TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(message_id, user_id, emoji)
);
-->
</body>
</html>